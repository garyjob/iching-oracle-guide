<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>I Ching Hexagram Calculator</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg" />
    <script src="scripts/hexagram_texts.js" defer></script>
    <style>
      :root {
        color-scheme: light;
        --bg: #f9f4ee;
        --bg-strong: #fffdf9;
        --panel: rgba(255, 255, 255, 0.82);
        --ink: #24160b;
        --ink-soft: #5e4632;
        --accent: #b9894c;
        --accent-strong: #8f6124;
        --accent-soft: rgba(185, 137, 76, 0.18);
        --border: rgba(36, 22, 11, 0.18);
        --shadow: 0 32px 70px rgba(46, 32, 20, 0.14);
        --radius-lg: 28px;
        --radius-md: 18px;
        --radius-sm: 12px;
        --transition: 220ms ease;
        font-synthesis: none;
        text-rendering: optimizeLegibility;
        font-family: "Inter", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 40px 18px 48px;
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.92) 0%, var(--bg) 55%, #efe3d4 100%);
        color: var(--ink);
      }

      main {
        width: min(1040px, 100%);
        background: var(--panel);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: clamp(24px, 4vw, 48px);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: clamp(24px, 4vw, 40px);
      }

      header.hero {
        display: grid;
        gap: clamp(12px, 3vw, 28px);
        text-align: left;
      }

      .hero-brand {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 16px;
        flex-wrap: wrap;
      }

      .brand-banner {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .brand-logo {
        width: clamp(120px, 18vw, 180px);
        height: auto;
        filter: drop-shadow(0 10px 24px rgba(36, 22, 11, 0.2));
      }

      .hero-badge {
        padding: 6px 14px;
        border-radius: 999px;
        background: rgba(185, 137, 76, 0.16);
        color: var(--accent-strong);
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .hero-content {
        display: grid;
        gap: 18px;
      }

      .hero-content h1 {
        margin: 0;
      }

      .hero-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      #beginCasting {
        min-width: 180px;
      }

      .hero-glass {
        margin-top: clamp(12px, 3vw, 20px);
        padding: 18px 20px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(255, 255, 255, 0.3);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.62), rgba(185, 137, 76, 0.12));
        box-shadow: 0 18px 32px rgba(36, 22, 11, 0.12);
        display: grid;
        gap: 8px;
        color: var(--ink);
      }

      .hero-glass.has-reading {
        border-color: rgba(185, 137, 76, 0.32);
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.72), rgba(185, 137, 76, 0.18));
      }

      .hero-glass-title {
        font-weight: 600;
        letter-spacing: 0.02em;
        color: var(--accent-strong);
      }

      .hero-glass-body {
        font-size: 0.95rem;
        color: var(--ink-soft);
        line-height: 1.5;
      }

      .hero-glass-status {
        margin: 0;
        font-size: 0.8rem;
        color: rgba(36, 22, 11, 0.6);
        letter-spacing: 0.02em;
      }

      .hero-glass-status.info {
        color: rgba(36, 22, 11, 0.6);
      }

      .hero-glass-status.success {
        color: var(--accent-strong);
      }

      .hero-glass-status.warning {
        color: #ad711b;
      }

      .hero-glass-status.error {
        color: #a13528;
      }

      .hero-glass-primary {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
        align-items: center;
        margin: 0;
      }

      .hero-glass-arrow {
        font-weight: 600;
        color: var(--accent-strong);
      }

      .hero-glass-static {
        color: var(--ink-soft);
        font-style: italic;
      }

      .hero-glass-meta {
        margin: 0;
        font-size: 0.82rem;
        color: rgba(36, 22, 11, 0.6);
      }

      h1 {
        margin: 0;
        font-size: clamp(2rem, 3vw, 2.7rem);
        font-weight: 700;
        letter-spacing: -0.02em;
        color: var(--accent-strong);
      }

      p.lead {
        margin: 0 auto;
        max-width: 52ch;
        line-height: 1.65;
        color: var(--ink-soft);
        font-size: clamp(0.98rem, 1.6vw, 1.1rem);
      }

      .overview-panel {
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--bg-strong);
        padding: 0;
        overflow: hidden;
      }

      .reference-panel {
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--bg-strong);
        overflow: hidden;
      }

      .reference-details > summary {
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        padding: 16px 20px;
        font-weight: 600;
        letter-spacing: 0.01em;
        cursor: pointer;
        color: var(--accent-strong);
      }

      .reference-details > summary::-webkit-details-marker {
        display: none;
      }

      .reference-details > summary::after {
        content: "⯈";
        font-size: 0.9rem;
        transition: transform var(--transition);
      }

      .reference-details[open] > summary::after {
        transform: rotate(90deg);
      }

      .reference-details[open] > summary {
        border-bottom: 1px solid var(--border);
        background: rgba(185, 137, 76, 0.08);
      }

      @media (min-width: 960px) {
        .casting-shell {
          grid-template-columns: minmax(0, 1fr) minmax(240px, 320px);
          align-items: start;
        }

        .line-steps {
          display: grid;
          grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
          overflow: visible;
          padding: 0;
        }

        .line-step {
          min-width: 0;
        }

        .actions-wrap {
          position: sticky;
          top: 24px;
        }
      }

      .reference-content {
        display: grid;
        gap: 16px;
        padding: 20px;
      }

      .reference-intro {
        font-size: 0.92rem;
        color: var(--ink-soft);
        line-height: 1.6;
      }

      .reference-table-wrap {
        overflow-x: auto;
      }

      #hexagramReferenceTable {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.92rem;
        background: white;
        border-radius: var(--radius-sm);
        overflow: hidden;
        box-shadow: 0 8px 18px rgba(36, 22, 11, 0.08);
      }

      #hexagramReferenceTable caption {
        caption-side: top;
        padding-bottom: 12px;
        font-weight: 600;
        color: var(--accent-strong);
        text-align: left;
      }

      #hexagramReferenceTable th,
      #hexagramReferenceTable td {
        border: 1px solid rgba(36, 22, 11, 0.1);
        padding: 10px 12px;
        text-align: center;
      }

      #hexagramReferenceTable thead th {
        background: rgba(185, 137, 76, 0.12);
        color: var(--ink);
        font-weight: 600;
      }

      .reference-corner {
        min-width: 150px;
        text-align: left;
      }

      .reference-heading {
        display: grid;
        gap: 4px;
        justify-items: center;
      }

      .reference-heading small {
        display: block;
        font-weight: 500;
        color: var(--ink-soft);
        font-size: 0.76rem;
      }

      .trigram-symbol {
        font-size: 1.4rem;
      }

      #hexagramReferenceTable tbody th {
        background: rgba(36, 22, 11, 0.05);
        font-weight: 600;
        text-align: left;
      }

      .reference-cell {
        display: grid;
        gap: 4px;
      }

      .reference-cell strong {
        font-size: 1rem;
        color: var(--ink);
      }

      .reference-cell span {
        font-size: 0.78rem;
        color: var(--ink-soft);
      }

      .overview-panel summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        list-style: none;
        margin: 0;
        padding: 16px 20px;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.01em;
        color: var(--accent-strong);
        font-size: 1.02rem;
      }

      .overview-panel summary::-webkit-details-marker {
        display: none;
      }

      .overview-panel summary::after {
        content: "+";
        font-size: 1.2rem;
        line-height: 1;
        font-weight: 600;
        color: var(--accent-strong);
        transition: transform var(--transition);
      }

      .overview-panel[open] summary {
        border-bottom: 1px solid var(--border);
        background: rgba(185, 137, 76, 0.08);
      }

      .overview-panel[open] summary::after {
        content: "-";
      }

      .overview-panel summary:focus-visible {
        outline: 2px solid rgba(185, 137, 76, 0.4);
        outline-offset: 4px;
      }

      .overview-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
        padding: 18px 20px 20px;
      }

      .overview-card {
        background: var(--bg-strong);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 18px 20px;
        display: grid;
        gap: 10px;
      }

      .overview-card.highlight {
        background: linear-gradient(135deg, rgba(185, 137, 76, 0.18), rgba(255, 255, 255, 0.88));
        border-color: rgba(185, 137, 76, 0.3);
      }

      .overview-card h2 {
        margin: 0;
        font-size: 1.05rem;
        color: var(--accent-strong);
        letter-spacing: 0.01em;
      }

      .guide-list {
        margin: 0;
        padding-left: 20px;
        display: grid;
        gap: 6px;
        color: var(--ink-soft);
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .progress-area {
        background: var(--bg-strong);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 18px 20px;
        display: grid;
        gap: 12px;
      }

      .progress-heading {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        font-size: 0.95rem;
        color: var(--ink-soft);
      }

      .progress-heading strong {
        font-size: 1rem;
        color: var(--ink);
      }

      .progress-track {
        position: relative;
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: rgba(36, 22, 11, 0.08);
        overflow: hidden;
      }

      .progress-indicator {
        position: absolute;
        inset: 0;
        width: 0%;
        background: linear-gradient(90deg, var(--accent) 0%, var(--accent-strong) 100%);
        transition: width var(--transition);
      }

      .progress-indicator.complete::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.35), transparent);
        mix-blend-mode: screen;
      }

      .line-flow {
        display: grid;
        gap: 20px;
      }

      .line-flow-header {
        display: grid;
        gap: 6px;
      }

      .line-flow-header h2 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--ink);
      }

      .line-flow-header p {
        margin: 0;
        font-size: 0.92rem;
        color: var(--ink-soft);
      }

      .casting-shell {
        display: grid;
        gap: clamp(20px, 4vw, 32px);
      }

      .line-steps {
        display: flex;
        gap: 12px;
        overflow-x: auto;
        padding: 2px 2px 6px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }

      .line-step {
        display: grid;
        gap: 4px;
        padding: 14px 16px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(36, 22, 11, 0.12);
        background: rgba(255, 255, 255, 0.85);
        color: var(--ink);
        text-align: left;
        cursor: pointer;
        transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
        font: inherit;
        min-width: 200px;
        scroll-snap-align: start;
      }

      .line-step:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(36, 22, 11, 0.12);
      }

      .line-step:disabled {
        cursor: not-allowed;
        opacity: 0.45;
        transform: none;
      }

      .line-step .step-label {
        font-weight: 600;
      }

      .line-step .step-role {
        font-size: 0.82rem;
        color: var(--ink-soft);
      }

      .line-step .step-status {
        font-size: 0.78rem;
        color: rgba(36, 22, 11, 0.65);
      }

      .line-step.active-step {
        border-color: rgba(185, 137, 76, 0.55);
        box-shadow: 0 12px 24px rgba(185, 137, 76, 0.18);
        transform: translateY(-2px);
      }

      .line-step.completed-step {
        border-color: rgba(36, 22, 11, 0.3);
      }

      .line-step.has-change {
        border-color: rgba(185, 137, 76, 0.55);
        background: linear-gradient(140deg, rgba(185, 137, 76, 0.16), rgba(255, 255, 255, 0.92));
      }

      .line-inputs {
        position: relative;
        min-height: 240px;
      }

      .line-card {
        display: none;
        gap: 14px;
        padding: 18px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--bg-strong);
        transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
      }

      .line-card.active-line {
        display: grid;
      }

      .line-card.active-line:hover {
        transform: translateY(-3px);
        box-shadow: 0 16px 32px rgba(36, 22, 11, 0.12);
      }

      .line-card.active-line:focus-within {
        border-color: rgba(185, 137, 76, 0.6);
        transform: translateY(-2px);
        box-shadow: 0 18px 34px rgba(36, 22, 11, 0.16);
      }

      .line-card.completed {
        border-color: rgba(36, 22, 11, 0.22);
        box-shadow: 0 14px 28px rgba(36, 22, 11, 0.1);
      }

      .line-card.has-change {
        border-color: rgba(185, 137, 76, 0.6);
        background: linear-gradient(160deg, rgba(185, 137, 76, 0.16), rgba(255, 255, 255, 0.92));
      }

      .line-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .line-meta {
        display: grid;
        gap: 2px;
      }

      .line-name {
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .line-role {
        font-size: 0.86rem;
        color: var(--ink-soft);
      }

      .line-preview {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mini-line {
        width: 78px;
        height: 14px;
        border-radius: 7px;
        background: rgba(36, 22, 11, 0.12);
        position: relative;
        overflow: hidden;
        transition: background var(--transition), transform var(--transition);
      }

      .mini-line.solid {
        background: rgba(36, 22, 11, 0.9);
      }

      .mini-line.broken {
        background: linear-gradient(
          to right,
          rgba(36, 22, 11, 0.85) 0%,
          rgba(36, 22, 11, 0.85) 32%,
          transparent 32%,
          transparent 68%,
          rgba(36, 22, 11, 0.85) 68%,
          rgba(36, 22, 11, 0.85) 100%
        );
      }

      .mini-line.changing {
        box-shadow: 0 0 0 2px rgba(185, 137, 76, 0.35);
      }

      .line-detail-text {
        font-size: 0.85rem;
        color: var(--ink-soft);
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .select-group {
        display: grid;
        gap: 6px;
        min-width: 180px;
      }

      .select-label {
        font-size: 0.84rem;
        letter-spacing: 0.01em;
        color: var(--ink-soft);
        font-weight: 600;
      }

      .auto-apply-hint {
        font-size: 0.78rem;
        color: var(--accent-strong);
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .auto-apply-hint::before {
        content: "✓";
        font-weight: 700;
        font-size: 0.8rem;
      }

      select {
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        border: 1px solid rgba(36, 22, 11, 0.22);
        background: white;
        font-size: 1rem;
        min-width: 140px;
        color: var(--ink);
        transition: border-color var(--transition), box-shadow var(--transition);
      }

      select:focus {
        outline: none;
        border-color: var(--accent-strong);
        box-shadow: 0 0 0 3px rgba(185, 137, 76, 0.24);
      }

      button {
        padding: 11px 18px;
        border-radius: 999px;
        border: none;
        background: var(--accent-strong);
        color: white;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.01em;
        transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 32px rgba(143, 97, 36, 0.28);
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.42;
        box-shadow: none;
        transform: none;
      }

      button.secondary {
        background: rgba(36, 22, 11, 0.76);
      }

      button.ghost {
        background: transparent;
        color: var(--accent-strong);
        border: 1px solid rgba(185, 137, 76, 0.4);
        box-shadow: none;
      }

      button.ghost:hover {
        background: rgba(185, 137, 76, 0.08);
        transform: none;
      }

      .toss-button.optional-action {
        background: rgba(36, 22, 11, 0.08);
        color: var(--ink);
        border: 1px dashed rgba(36, 22, 11, 0.26);
      }

      .toss-button.optional-action:hover {
        box-shadow: none;
        transform: none;
        background: rgba(36, 22, 11, 0.12);
      }

      .tooltip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(36, 22, 11, 0.15);
        color: var(--accent-strong);
        font-size: 0.78rem;
        font-weight: 600;
        cursor: help;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
      }

      .actions-wrap {
        display: grid;
        gap: 18px;
      }

      #results {
        display: none;
        gap: 20px;
      }

      #results.active {
        display: grid;
      }

      .results-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      .share-button {
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-strong) 100%);
        color: white;
        border: none;
        border-radius: 999px;
        padding: 12px 20px;
        font-weight: 600;
        letter-spacing: 0.01em;
        cursor: pointer;
        transition: transform var(--transition), box-shadow var(--transition), opacity var(--transition);
      }

      .share-button:disabled {
        opacity: 0.45;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
      }

      .share-button:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 30px rgba(143, 97, 36, 0.28);
      }

      .share-feedback {
        font-size: 0.88rem;
        color: var(--accent-strong);
      }

      .hexagram-fulltext {
        border: 1px solid rgba(36, 22, 11, 0.1);
        border-radius: var(--radius-sm);
        background: rgba(255, 255, 255, 0.66);
        overflow: hidden;
      }

      .hexagram-fulltext > summary {
        margin: 0;
        padding: 14px 16px;
        font-weight: 600;
        letter-spacing: 0.01em;
        cursor: pointer;
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        color: var(--accent-strong);
      }

      .hexagram-fulltext > summary::-webkit-details-marker {
        display: none;
      }

      .hexagram-fulltext > summary::after {
        content: "⯈";
        font-size: 0.9rem;
        transition: transform var(--transition);
      }

      .hexagram-fulltext[open] > summary::after {
        transform: rotate(90deg);
      }

      .hexagram-fulltext[open] > summary {
        background: rgba(185, 137, 76, 0.08);
        border-bottom: 1px solid rgba(36, 22, 11, 0.08);
      }

      .hexagram-fulltext .fulltext-body {
        padding: 18px 20px;
        display: grid;
        gap: 14px;
        font-size: 0.95rem;
        color: var(--ink-soft);
        line-height: 1.6;
      }

      .hexagram-fulltext .fulltext-section {
        display: grid;
        gap: 6px;
      }

      .hexagram-fulltext .fulltext-section strong {
        color: var(--ink);
      }

      .hexagram-fulltext .line-text-list {
        margin: 0;
        padding-left: 20px;
        display: grid;
        gap: 6px;
      }

      .hexagram-fulltext .line-text-entry.line-change {
        position: relative;
        padding: 6px 10px;
        border-radius: var(--radius-sm);
        background: rgba(185, 137, 76, 0.12);
        color: var(--ink);
      }

      .hexagram-fulltext .line-text-entry.line-change::before {
        content: "Changing line";
        display: block;
        font-size: 0.72rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: var(--accent-strong);
        margin-bottom: 2px;
      }

      .hexagram-fulltext .fulltext-empty {
        font-style: italic;
        color: rgba(36, 22, 11, 0.6);
      }

      .line-summary {
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--bg-strong);
        padding: 22px;
        display: grid;
        gap: 16px;
      }

      .line-summary h2 {
        margin: 0;
        font-size: 1.15rem;
        color: var(--accent-strong);
      }

      .line-grid {
        display: grid;
        gap: 12px;
      }

      .line-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        padding: 12px 14px;
        border-radius: var(--radius-sm);
        background: rgba(36, 22, 11, 0.08);
        align-items: center;
      }

      .line-row.changing {
        background: var(--accent-soft);
        border: 1px solid rgba(185, 137, 76, 0.36);
      }

      .line-row strong {
        color: var(--ink);
      }

      .hexagram-section {
        display: grid;
        gap: 18px;
      }

      .hexagram-layout {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        align-items: start;
      }

      .hexagram-card {
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        background: var(--bg-strong);
        padding: 22px;
        display: grid;
        gap: 16px;
        box-shadow: 0 12px 24px rgba(36, 22, 11, 0.08);
      }

      .hexagram-card h2 {
        margin: 0;
        color: var(--accent-strong);
        font-size: 1.1rem;
      }

      .hexagram-diagram {
        display: grid;
        gap: 10px;
      }

      .hexagram-line {
        position: relative;
        height: 22px;
        border-radius: 6px;
        background: rgba(36, 22, 11, 0.12);
        overflow: hidden;
      }

      .hexagram-line.solid {
        background: rgba(36, 22, 11, 0.88);
      }

      .hexagram-line.broken {
        background: linear-gradient(
          to right,
          rgba(36, 22, 11, 0.88) 0%,
          rgba(36, 22, 11, 0.88) 33%,
          transparent 33%,
          transparent 67%,
          rgba(36, 22, 11, 0.88) 67%,
          rgba(36, 22, 11, 0.88) 100%
        );
      }

      .hexagram-line.changing {
        box-shadow: 0 0 0 3px rgba(185, 137, 76, 0.4);
      }

      .hexagram-info h3 {
        margin: 0;
        font-size: 1.06rem;
        color: var(--ink);
      }

      .hexagram-info p {
        margin: 0;
        line-height: 1.6;
        color: var(--ink-soft);
        font-size: 0.95rem;
      }

      #secondaryNote {
        margin: 0;
        font-size: 0.95rem;
        color: var(--ink-soft);
        text-align: center;
      }

      footer {
        text-align: center;
        font-size: 0.85rem;
        color: var(--ink-soft);
      }

      footer strong {
        color: var(--accent-strong);
      }

      @media (max-width: 720px) {
        body {
          padding: 24px 14px 32px;
        }

        main {
          gap: 28px;
        }

        header.hero {
          gap: 22px;
        }

        .hero-brand {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .hero-steps {
          flex-direction: column;
          gap: 10px;
        }

        .hero-actions {
          flex-direction: column;
          align-items: stretch;
        }

        .hero-actions button {
          width: 100%;
        }

        .hero-glass {
          order: 3;
        }

        .overview-content {
          grid-template-columns: 1fr;
        }

        .actions {
          flex-direction: column;
        }

        .actions-wrap {
          display: flex;
          flex-direction: column;
          gap: 16px;
        }

        .actions-wrap .progress-area {
          order: -1;
        }

        .actions button {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 18px 12px 28px;
          background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, var(--bg) 100%);
        }

        main {
          padding: 22px 18px;
          border-radius: 22px;
          gap: 24px;
        }

        h1 {
          font-size: clamp(1.65rem, 6vw, 2rem);
        }

        p.lead {
          font-size: 0.98rem;
          text-align: left;
        }

        .overview-card,
        .progress-area,
        .line-card,
        .line-summary,
        .hexagram-card {
          padding: 16px;
        }

        .line-card {
          gap: 12px;
        }

        .line-top {
          flex-direction: column;
          gap: 6px;
        }

        .line-role {
          font-size: 0.82rem;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        select,
        .controls button {
          width: 100%;
        }

        .mini-line {
          width: 100%;
          height: 16px;
        }

        .line-step {
          min-width: 160px;
        }

        .hero-steps li {
          width: 100%;
        }

        .line-grid,
        .hexagram-layout {
          gap: 14px;
        }

        .line-row {
          grid-template-columns: 1fr;
          gap: 6px;
          padding: 12px;
        }

        .hexagram-layout {
          grid-template-columns: 1fr;
        }

        .hexagram-info p,
        .hexagram-info h3 {
          font-size: 0.95rem;
        }

        .progress-area {
          position: sticky;
          top: 12px;
          z-index: 2;
          box-shadow: 0 12px 24px rgba(36, 22, 11, 0.12);
        }

        .actions {
          position: sticky;
          bottom: 12px;
          gap: 10px;
          background: rgba(249, 244, 238, 0.92);
          padding: 14px 16px;
          border-radius: 18px;
          box-shadow: 0 16px 28px rgba(36, 22, 11, 0.12);
        }

        footer {
          font-size: 0.82rem;
          text-align: left;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header class="hero" aria-label="TrueSight Oracle introduction">
        <div class="hero-brand">
          <div class="brand-banner" role="presentation">
            <img src="assets/truesight-logo.png" alt="TrueSight DAO logo" class="brand-logo" />
          </div>
          <span class="hero-badge">Daily Oracle</span>
        </div>
        <div class="hero-content">
        <h1>I Ching Daily Guidance</h1>
        <p class="lead">
            Tune into the moment with the Wilhelm/Baynes three-coin method. Set each line from the ground up
            or let the oracle toss for you—insight arrives either way.
          </p>
          <div class="hero-actions">
            <button id="beginCasting" type="button">Begin your cast</button>
            <button id="lastReadingButton" class="ghost" type="button" hidden>View saved insight</button>
            <button id="refreshAssets" class="ghost" type="button" hidden>Refresh assets</button>
          </div>
        </div>
        <aside class="hero-glass" id="heroGlass" aria-live="polite">
          <div class="hero-glass-title">Saved insight</div>
          <div class="hero-glass-body" id="lastReadingPreview">
            <p>Each reading auto-saves so you can revisit it later today.</p>
          </div>
          <p class="hero-glass-status" id="heroStatus" hidden></p>
        </aside>
      </header>

      <details class="overview-panel" id="castingGuidance">
        <summary>Guidance &amp; tips</summary>
        <div class="overview-content" aria-label="Casting guidance">
          <article class="overview-card">
            <h2>Preparing Your Cast</h2>
            <ul class="guide-list">
              <li>Work from the bottom line upward—Line 1 anchors the hexagram.</li>
              <li>Each coin toss produces 0–3 heads. Tails are counted automatically.</li>
              <li>Solid lines represent yang (movement); broken lines show yin (receptive).</li>
            </ul>
          </article>
          <article class="overview-card highlight">
            <h2>Coin Method Quick Math</h2>
            <ul class="guide-list">
              <li>Heads count as 3, tails count as 2—sum to find each line.</li>
              <li>6 = old yin (changing to yang); 7 = young yang; 8 = young yin; 9 = old yang (changing to yin).</li>
              <li>Changing lines reveal a relating hexagram—trace both for nuance.</li>
            </ul>
          </article>
        </div>
      </details>

      <section class="casting-shell" aria-label="Casting workspace">
      <section class="line-flow">
          <div class="line-flow-header">
            <h2>Cast your lines</h2>
            <p>Follow the sequence below—each choice updates instantly.</p>
          </div>
        <nav class="line-steps" id="lineTimeline" aria-label="Line sequence"></nav>
          <section class="line-inputs" id="lineInputs" aria-label="Line inputs"></section>
      </section>

      <section class="actions-wrap" aria-label="Actions and progress">
        <div class="actions">
          <button id="tossAll" class="ghost" type="button">Toss All Lines</button>
          <button id="calculate" type="button" disabled>Reveal Guidance</button>
          <button id="reset" class="secondary" type="button">New Reading</button>
        </div>

        <section class="progress-area" aria-live="polite">
          <div class="progress-heading">
            <strong>Line Progress</strong>
            <span id="progressLabel">0 / 6 lines set</span>
          </div>
          <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="6" aria-valuenow="0">
            <div class="progress-indicator" id="progressBar"></div>
          </div>
          </section>
        </section>
      </section>

      <section id="results">
        <div class="results-actions">
          <button id="shareReading" class="share-button" type="button" disabled>Share today’s reading</button>
          <span class="share-feedback" id="shareFeedback" hidden></span>
        </div>
        <article class="line-summary" aria-live="polite"></article>
        <section class="hexagram-section">
          <div class="hexagram-layout" id="hexagramDisplay"></div>
          <p id="secondaryNote" hidden></p>
        </section>
      </section>

      <section class="reference-panel" aria-label="Hexagram reference guide">
        <details id="hexagramReference" class="reference-details">
          <summary>Explore the 64 hexagrams</summary>
          <div class="reference-content">
            <div class="reference-intro">
              Use this lookup to cross-reference the primary and relating trigrams. Lower trigrams run along
              the rows; upper trigrams span the columns.
            </div>
            <div class="reference-table-wrap">
              <table id="hexagramReferenceTable" aria-describedby="referenceCaption">
                <caption id="referenceCaption">
                  Hexagram numbers by lower (rows) and upper (columns) trigram combinations
                </caption>
              </table>
            </div>
          </div>
        </details>
      </section>

      <footer>
        <strong>Note:</strong> Lines highlighted in amber indicate changing energy—flip them to unveil the relating hexagram.
      </footer>
    </main>

    <script>
      const totalLines = 6;
      const headsOptions = [
        { value: "", label: "Select heads" },
        { value: "0", label: "0 heads (3 tails)" },
        { value: "1", label: "1 head (2 tails)" },
        { value: "2", label: "2 heads (1 tail)" },
        { value: "3", label: "3 heads (0 tails)" }
      ];

      const lineTooltips = {
        1: "Line 1 (bottom): Foundation—how you begin.",
        2: "Line 2: Inner movement—align actions carefully.",
        3: "Line 3: Transition—watch for obstacles.",
        4: "Line 4: Outer movement—bridging to the world.",
        5: "Line 5: Leadership—center of influence.",
        6: "Line 6 (top): Completion—how things conclude."
      };

      const lineRoles = {
        1: "Foundation — Earthly base",
        2: "Inner support — Align within",
        3: "Threshold — Crossroads energy",
        4: "Outreach — Bridge to others",
        5: "Heart — Guiding influence",
        6: "Culmination — Release outcome"
      };

      const lineNatureDescriptions = {
        6: "6 — old yin transforms to yang",
        7: "7 — young yang holds firm",
        8: "8 — young yin stays open",
        9: "9 — old yang transforms to yin"
      };

      const trigramInfo = [
        { key: "chien", name: "Ch'ien", english: "Heaven", symbol: "☰" },
        { key: "chen", name: "Chên", english: "Thunder", symbol: "☳" },
        { key: "kan", name: "K'an", english: "Water", symbol: "☵" },
        { key: "ken", name: "Kên", english: "Mountain", symbol: "☶" },
        { key: "kun", name: "K'un", english: "Earth", symbol: "☷" },
        { key: "sun", name: "Sun", english: "Wind", symbol: "☴" },
        { key: "li", name: "Li", english: "Fire", symbol: "☲" },
        { key: "tui", name: "Tui", english: "Lake", symbol: "☱" }
      ];

      const trigramMap = {
        0b000: 4, // K'un (Earth)
        0b001: 1, // Chên (Thunder)
        0b010: 2, // K'an (Water)
        0b011: 7, // Tui (Lake)
        0b100: 3, // Kên (Mountain)
        0b101: 5, // Sun (Wind)
        0b110: 6, // Li (Fire)
        0b111: 0 // Ch'ien (Heaven)
      };

      const hexagramChart = [
        [
          { number: 1, name: "Ch'ien / The Creative" },
          { number: 34, name: "Ta Chuang / The Power of the Great" },
          { number: 5, name: "Hsü / Waiting" },
          { number: 26, name: "Ta Ch'u / The Taming Power of the Great" },
          { number: 11, name: "T'ai / Peace" },
          { number: 9, name: "Hsiao Ch'u / The Taming Power of the Small" },
          { number: 14, name: "Ta Yu / Possession in Great Measure" },
          { number: 43, name: "Kuai / Break-through" }
        ],
        [
          { number: 25, name: "Wu Wang / Innocence" },
          { number: 51, name: "Chên / The Arousing" },
          { number: 3, name: "Chun / Difficulty at the Beginning" },
          { number: 27, name: "I / The Corners of the Mouth" },
          { number: 24, name: "Fu / Return" },
          { number: 42, name: "I / Increase" },
          { number: 21, name: "Shih Ho / Biting Through" },
          { number: 17, name: "Sui / Following" }
        ],
        [
          { number: 6, name: "Sung / Conflict" },
          { number: 40, name: "Hsieh / Deliverance" },
          { number: 29, name: "K'an / The Abysmal" },
          { number: 4, name: "Meng / Youthful Folly" },
          { number: 7, name: "Shih / The Army" },
          { number: 59, name: "Huan / Dispersion" },
          { number: 64, name: "Wei Chi / Before Completion" },
          { number: 47, name: "K'un / Oppression" }
        ],
        [
          { number: 33, name: "Tun / Retreat" },
          { number: 62, name: "Hsiao Kuo / Preponderance of the Small" },
          { number: 39, name: "Chien / Obstruction" },
          { number: 52, name: "Kên / Keeping Still" },
          { number: 15, name: "Ch'ien / Modesty" },
          { number: 53, name: "Chien / Development" },
          { number: 56, name: "Lü / The Wanderer" },
          { number: 31, name: "Hsien / Influence" }
        ],
        [
          { number: 12, name: "P'i / Standstill" },
          { number: 16, name: "Yü / Enthusiasm" },
          { number: 8, name: "Pi / Holding Together" },
          { number: 23, name: "Po / Splitting Apart" },
          { number: 2, name: "K'un / The Receptive" },
          { number: 20, name: "Kuan / Contemplation" },
          { number: 35, name: "Chin / Progress" },
          { number: 45, name: "Ts'ui / Gathering Together" }
        ],
        [
          { number: 44, name: "Kou / Coming to Meet" },
          { number: 32, name: "Heng / Duration" },
          { number: 48, name: "Ching / The Well" },
          { number: 18, name: "Ku / Work on What Has Been Spoiled" },
          { number: 46, name: "Shêng / Pushing Upward" },
          { number: 57, name: "Sun / The Gentle" },
          { number: 50, name: "Ting / The Cauldron" },
          { number: 28, name: "Ta Kuo / Preponderance of the Great" }
        ],
        [
          { number: 13, name: "T'ung Jên / Fellowship with Men" },
          { number: 55, name: "Fêng / Abundance" },
          { number: 63, name: "Chi Chi / After Completion" },
          { number: 22, name: "Pi / Grace" },
          { number: 36, name: "Ming I / Darkening of the Light" },
          { number: 37, name: "Chia Jên / The Family" },
          { number: 30, name: "Li / The Clinging" },
          { number: 49, name: "Ko / Revolution" }
        ],
        [
          { number: 10, name: "Lü / Treading" },
          { number: 54, name: "Kuei Mei / The Marrying Maiden" },
          { number: 60, name: "Chieh / Limitation" },
          { number: 41, name: "Sun / Decrease" },
          { number: 19, name: "Lin / Approach" },
          { number: 61, name: "Chung Fu / Inner Truth" },
          { number: 38, name: "K'uei / Opposition" },
          { number: 58, name: "Tui / The Joyous" }
        ]
      ];

      const hexagramDetails = {
        1: {
          judgment: "Creative force gathers; initiate bold, clear action.",
          image: "Heaven moves with power—align with its rhythm and lead."
        },
        2: {
          judgment: "Yielding strength; accept guidance and nurture growth.",
          image: "Earth's vast embrace supports all—remain receptive and steady." },
        3: {
          judgment: "Beginnings are tangled—persist patiently and organize.",
          image: "Thunder within the soil—prepare the ground before planting." },
        4: {
          judgment: "Ignorance seeks instruction—cultivate humility and learn.",
          image: "A spring emerges from a mountain—guide it with discipline." },
        5: {
          judgment: "Wait with inner certainty; nourishment arrives in time.",
          image: "Clouds climb the sky—do not force the rain before it is ready." },
        6: {
          judgment: "Conflict requires clarity and fair counsel.",
          image: "Water climbs toward heaven—seek resolution before strife hardens." },
        7: {
          judgment: "Discipline your forces; unity wins devoted allies.",
          image: "Water within the earth—assemble the troops with purpose." },
        8: {
          judgment: "Join with others through shared sincerity and vision.",
          image: "Water above earth—gather the clan and declare your center." },
        9: {
          judgment: "Small accumulations sustain progress; tend to details.",
          image: "Wind moves within heaven—cultivate gentle influence." },
        10: {
          judgment: "Advance carefully; behave with respect and grace.",
          image: "Heaven above the lake—watch your steps like a tiger on the trail." },
        11: {
          judgment: "Harmony prospers; share abundance widely.",
          image: "Heaven and earth unite—establish balance between realms." },
        12: {
          judgment: "Stagnation blocks virtue; withdraw and preserve integrity.",
          image: "Heaven withdraws from earth—maintain inner worth amid decline." },
        13: {
          judgment: "Fellowship flourishes when motives remain pure.",
          image: "Heaven over fire—the clan gathers in the open plain." },
        14: {
          judgment: "Great possessions invite responsibility; act nobly.",
          image: "Fire high in heaven—radiate generosity without arrogance." },
        15: {
          judgment: "Modesty enriches; reduce excess and extend courtesy.",
          image: "Mountain beneath earth—weight settles evenly on all." },
        16: {
          judgment: "Enthusiasm rallies hearts; prepare by aligning intentions.",
          image: "Thunder bursts from the earth—lead with shared purpose." },
        17: {
          judgment: "Follow what is true; loyalty wins loyal allies.",
          image: "Thunder within the lake—respond to joy with sincerity." },
        18: {
          judgment: "Repair what is spoiled; act decisively to renew.",
          image: "Wind blows over the mountain—patient effort restores order." },
        19: {
          judgment: "Approach with openness; nurture those you lead.",
          image: "Earth welcomes the lake—prepare for arrival by serving others." },
        20: {
          judgment: "Contemplate the broader view before committing.",
          image: "Wind crosses earth—survey the land and refine your conduct." },
        21: {
          judgment: "Bite through obstacles with firm justice.",
          image: "Thunder and fire combine—discern truth and act decisively." },
        22: {
          judgment: "Grace embellishes; let beauty support substance.",
          image: "Fire at the mountain's foot—adorn yet remain grounded." },
        23: {
          judgment: "Peeling away reveals truth; accept necessary endings.",
          image: "Mountain above earth—structures crumble, prepare to rebuild." },
        24: {
          judgment: "Return to the path; renewal follows reflection.",
          image: "Thunder within earth—rest then rise with new commitment." },
        25: {
          judgment: "Innocence aligns with the Tao—avoid cunning.",
          image: "Heaven within thunder—act without ulterior motive." },
        26: {
          judgment: "Tame great power with patience and study.",
          image: "Heaven within the mountain—store strength until needed." },
        27: {
          judgment: "Nourish words and deeds; watch what feeds you.",
          image: "Mountain surrounds thunder—shape your mouth with integrity." },
        28: {
          judgment: "Excessive weight strains the beam—reinforce or release.",
          image: "Lake above wind—support the center before collapse." },
        29: {
          judgment: "Repeated trials demand courage and trust.",
          image: "Water flows endlessly—navigate the abyss with discipline." },
        30: {
          judgment: "Clarity illuminates; cling to what is bright.",
          image: "Fire repeated—tend the flame with mindful devotion." },
        31: {
          judgment: "Gentle influence attracts partnership.",
          image: "Lake at the mountain's foot—respond softly and inspire." },
        32: {
          judgment: "Consistency breeds success; commit for the long term.",
          image: "Thunder and wind entwine—endurance shapes destiny." },
        33: {
          judgment: "Retreat strategically to preserve strength.",
          image: "Heaven on the mountain—withdraw before force overwhelms." },
        34: {
          judgment: "Great power requires restraint and clarity.",
          image: "Thunder rises to heaven—align strength with goodness." },
        35: {
          judgment: "Progress grows through steady effort and courtesy.",
          image: "Fire emerges over earth—dawn reveals new promise." },
        36: {
          judgment: "Protect the light under adversity.",
          image: "Fire sinks beneath earth—hide brilliance until safe." },
        37: {
          judgment: "Order the family; align roles with kindness.",
          image: "Wind within fire—cultivate warmth in the home." },
        38: {
          judgment: "Opposition sparks clarity—seek common ground.",
          image: "Fire above lake—differ yet stay in respectful dialogue." },
        39: {
          judgment: "Obstacles counsel pause; seek assistance.",
          image: "Water at the mountain—turn back to regroup." },
        40: {
          judgment: "Release tension; forgive and move onward.",
          image: "Thunder and rain—storms cleanse and restore calm." },
        41: {
          judgment: "Decrease excess to reveal meaning.",
          image: "Mountain above lake—choose simplicity over indulgence." },
        42: {
          judgment: "Increase through generosity; give where it counts.",
          image: "Wind and thunder—growth follows wholehearted support." },
        43: {
          judgment: "Break through; declare truth openly.",
          image: "Lake surges to heaven—announce decisions without fear." },
        44: {
          judgment: "Encounter demands vigilance; set firm boundaries.",
          image: "Wind below heaven—meet the unexpected with awareness." },
        45: {
          judgment: "Gather community—offer a clear purpose.",
          image: "Lake above earth—draw people together with sincerity." },
        46: {
          judgment: "Rise steadily through devotion.",
          image: "Wind within earth—push upward with gentleness." },
        47: {
          judgment: "Oppression tests endurance—hold to inner truth.",
          image: "Water in the lake—remain faithful despite confinement." },
        48: {
          judgment: "The Well nourishes all—maintain purity.",
          image: "Water over wood—draw from the source responsibly." },
        49: {
          judgment: "Revolution succeeds with timing and sincerity.",
          image: "Fire in the lake—renew forms with heartfelt intent." },
        50: {
          judgment: "The Cauldron transforms—honor the sacred vessel.",
          image: "Fire over wood—nourish spirit and culture." },
        51: {
          judgment: "Shock awakens; respond with composure.",
          image: "Thunder repeated—stay rooted when startled." },
        52: {
          judgment: "Stillness clarifies—quiet the mind.",
          image: "Mountain upon mountain—remain centered within." },
        53: {
          judgment: "Gradual progress matures relationships.",
          image: "Tree on the mountain—growth is deliberate and sure." },
        54: {
          judgment: "Adapt to circumstance with dignity.",
          image: "Thunder over lake—honor commitments even when misaligned." },
        55: {
          judgment: "Abundance shines—share brilliance wisely.",
          image: "Thunder and fire—celebrate yet remain aware of decline." },
        56: {
          judgment: "The traveler succeeds with humility and decorum.",
          image: "Fire on the mountain—move lightly and respect customs." },
        57: {
          judgment: "Gentle penetration achieves influence.",
          image: "Wind repeats—persevering persuasion shapes fate." },
        58: {
          judgment: "Joy shared deepens trust.",
          image: "Lake repeats—dialogue creates harmony." },
        59: {
          judgment: "Disperse hardness; return to clarity.",
          image: "Wind over water—let sincerity dissolve barriers." },
        60: {
          judgment: "Limitation grants freedom through structure.",
          image: "Water above lake—set clear boundaries with compassion." },
        61: {
          judgment: "Inner truth guides lasting bonds.",
          image: "Wind within lake—sincerity moves hearts." },
        62: {
          judgment: "Attend the small; avoid grand gestures.",
          image: "Thunder above mountain—flight of the small bird." },
        63: {
          judgment: "Completion demands vigilance to sustain success.",
          image: "Water above fire—balance opposing forces with care." },
        64: {
          judgment: "Before completion—align pieces before acting.",
          image: "Fire above water—prepare thoroughly before the leap." }
      };

      const lineInputsContainer = document.getElementById("lineInputs");
      const calculateButton = document.getElementById("calculate");
      const resetButton = document.getElementById("reset");
      const tossAllButton = document.getElementById("tossAll");
      const resultsSection = document.getElementById("results");
      const lineSummarySection = document.querySelector(".line-summary");
      const hexagramDisplay = document.getElementById("hexagramDisplay");
      const secondaryNote = document.getElementById("secondaryNote");
      const progressLabel = document.getElementById("progressLabel");
      const progressBar = document.getElementById("progressBar");
      const progressTrack = document.querySelector(".progress-track");
      const lineTimeline = document.getElementById("lineTimeline");
      const shareButton = document.getElementById("shareReading");
      const shareFeedback = document.getElementById("shareFeedback");
      const beginCastingButton = document.getElementById("beginCasting");
      const lastReadingButton = document.getElementById("lastReadingButton");
      const heroGlass = document.getElementById("heroGlass");
      const lastReadingPreview = document.getElementById("lastReadingPreview");

      const STORAGE_KEY = "truesight-oracle-last-reading";

      const lineOrder = Array.from({ length: totalLines }, (_, index) => index + 1);
      let lineCardElements = [];
      let lineStepButtons = [];
      let currentLineIndex = 0;
      let currentReading = null;

      const textEncoder = new TextEncoder();
      const textDecoder = new TextDecoder();

      function encodeReadingPayload(reading) {
        const json = JSON.stringify(reading);
        const bytes = textEncoder.encode(json);
        let binary = "";
        bytes.forEach((byte) => {
          binary += String.fromCharCode(byte);
        });
        return btoa(binary);
      }

      function decodeReadingPayload(payload) {
        const binary = atob(payload);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i += 1) {
          bytes[i] = binary.charCodeAt(i);
        }
        const json = textDecoder.decode(bytes);
        return JSON.parse(json);
      }

      function createShareUrl(reading) {
        try {
          const encoded = encodeReadingPayload(reading);
          const url = new URL(window.location.href);
          url.search = "";
          url.hash = "";
          url.searchParams.set("reading", encoded);
          return url.toString();
        } catch (error) {
          console.warn("Unable to encode reading for share link:", error);
          return reading.url || window.location.href.split("#")[0];
        }
      }

      function createLineCard({ lineNumber, tooltip }) {
        const card = document.createElement("div");
        card.className = "line-card";
        card.dataset.lineNumber = lineNumber;

        const header = document.createElement("div");
        header.className = "line-top";
        const meta = document.createElement("div");
        meta.className = "line-meta";
        const title = document.createElement("span");
        title.className = "line-name";
        title.textContent = `Line ${lineNumber}`;
        const role = document.createElement("span");
        role.className = "line-role";
        role.textContent = lineRoles[lineNumber];
        meta.append(title, role);
        const tip = document.createElement("span");
        tip.className = "tooltip";
        tip.title = tooltip;
        tip.textContent = "?";
        header.append(meta, tip);

        const preview = document.createElement("div");
        preview.className = "line-preview";
        const miniLine = document.createElement("div");
        miniLine.className = "mini-line";
        miniLine.dataset.role = "mini-line";
        const status = document.createElement("span");
        status.className = "line-detail-text";
        status.dataset.role = "status-text";
        status.textContent = "Awaiting toss";
        preview.append(miniLine, status);

        const controls = document.createElement("div");
        controls.className = "controls";

        const selectGroup = document.createElement("div");
        selectGroup.className = "select-group";

        const selectLabel = document.createElement("label");
        selectLabel.className = "select-label";
        selectLabel.setAttribute("for", `heads-${lineNumber}`);
        selectLabel.textContent = "Heads (auto-applies):";

        const select = document.createElement("select");
        select.id = `heads-${lineNumber}`;
        select.name = `heads-${lineNumber}`;
        select.dataset.role = "heads";
        select.dataset.lineNumber = lineNumber;
        headsOptions.forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.label;
          select.append(option);
        });
        const autoHint = document.createElement("span");
        autoHint.className = "auto-apply-hint";
        autoHint.dataset.role = "auto-apply";
        autoHint.textContent = "Saved automatically";
        autoHint.hidden = true;
        selectGroup.append(selectLabel, select, autoHint);

        const tossButton = document.createElement("button");
        tossButton.type = "button";
        tossButton.className = "toss-button";
        tossButton.dataset.role = "toss-button";
        tossButton.textContent = "Toss for Me";
        tossButton.addEventListener("click", () => {
          const heads = simulateToss();
          select.value = heads.toString();
          updateLineResult(card, heads, { userSelected: false });
        });

        select.addEventListener("change", (event) => {
          const value = event.target.value;
          const index = Number(card.dataset.index || 0);
          if (value === "") {
            handleLineClear(index);
            return;
          }
          updateLineResult(card, Number(value), { userSelected: true });
        });

        controls.append(selectGroup, tossButton);
        card.append(header, preview, controls);
        return card;
      }

      function resetLineCard(card, { clearSelection = false, resetStep = true } = {}) {
        if (!card) return;

        if (clearSelection) {
          const select = card.querySelector("select[data-role='heads']");
          if (select) {
            select.value = "";
          }
        }

        card.classList.remove("completed", "has-change");
        const status = card.querySelector("[data-role='status-text']");
        const miniLine = card.querySelector("[data-role='mini-line']");
        if (status) {
          status.textContent = "Awaiting toss";
        }
        if (miniLine) {
          miniLine.className = "mini-line";
        }
        card.removeAttribute("data-sum");
        card.removeAttribute("data-changing");
        card.dataset.completed = "false";

        const autoHint = card.querySelector("[data-role='auto-apply']");
        if (autoHint) {
          autoHint.hidden = true;
        }
        const tossButton = card.querySelector("button[data-role='toss-button']");
        if (tossButton) {
          tossButton.classList.remove("optional-action");
          tossButton.textContent = "Toss for Me";
        }

        if (resetStep) {
          const index = Number(card.dataset.index || 0);
          updateStepSummary(index, null);
        }
      }

      function updateLineResult(card, heads, { userSelected = false } = {}) {
        const tails = 3 - heads;
        const sum = heads * 3 + tails * 2;
        const type = sum % 2 === 1 ? "solid" : "broken";
        const changing = sum === 6 || sum === 9;
        const index = Number(card.dataset.index || 0);
        const wasComplete = card.dataset.completed === "true";
        const status = card.querySelector("[data-role='status-text']");
        const miniLine = card.querySelector("[data-role='mini-line']");

        if (miniLine) {
          miniLine.className = "mini-line";
          miniLine.classList.add(type);
          if (changing) {
            miniLine.classList.add("changing");
          }
        }

        if (status) {
          const descriptor = lineNatureDescriptions[sum] || `Sum ${sum}`;
          status.textContent = `${descriptor} — ${heads}H / ${tails}T`;
          updateStepSummary(index, {
            descriptor,
            heads,
            tails,
            changing
          });
        }

        const autoHint = card.querySelector("[data-role='auto-apply']");
        if (autoHint) {
          autoHint.hidden = !userSelected;
        }
        const tossButton = card.querySelector("button[data-role='toss-button']");
        if (tossButton) {
          tossButton.classList.toggle("optional-action", userSelected);
          tossButton.textContent = userSelected ? "Toss Again (optional)" : "Toss for Me";
        }

        card.classList.add("completed");
        card.classList.toggle("has-change", changing);
        card.dataset.sum = String(sum);
        card.dataset.changing = changing ? "true" : "false";
        card.dataset.completed = "true";

        markStepCompleted(index, changing);

        if (!wasComplete && index === currentLineIndex) {
          const nextIndex = index + 1;
          if (nextIndex < lineCardElements.length) {
            activateLineByIndex(nextIndex);
          } else {
            currentLineIndex = index;
            lineStepButtons[index]?.classList.add("active-step");
            lineCardElements[index]?.classList.add("active-line");
          }
        }

        updateProgress();
        const selects = Array.from(document.querySelectorAll("select[data-role='heads']"));
        const completed = selects.every((sel) => sel.value !== "");
        if (completed) {
          handleCalculate();
        }
      }

      function updateStepSummary(index, summary) {
        const step = lineStepButtons[index];
        if (!step) return;
        const statusSpan = step.querySelector(".step-status");
        if (!statusSpan) return;

        if (!summary) {
          statusSpan.textContent = "Awaiting toss";
          step.classList.remove("completed-step", "has-change");
          return;
        }

        const { descriptor, heads, tails, changing } = summary;
        const counts = heads !== undefined ? ` — ${heads}H / ${tails}T` : "";
        statusSpan.textContent = `${descriptor}${counts}`;
        step.classList.add("completed-step");
        step.classList.toggle("has-change", Boolean(changing));
      }

      function markStepCompleted(index, isChanging) {
        const step = lineStepButtons[index];
        if (!step) return;
        step.disabled = false;
        step.classList.add("completed-step");
        step.classList.toggle("has-change", Boolean(isChanging));
        const nextStep = lineStepButtons[index + 1];
        if (nextStep) {
          nextStep.disabled = false;
        }
      }

      function activateLineByIndex(index) {
        const step = lineStepButtons[index];
        if (!step || step.disabled) return;
        currentLineIndex = index;

        lineCardElements.forEach((card, cardIndex) => {
          card.classList.toggle("active-line", cardIndex === index);
        });

        lineStepButtons.forEach((btn, btnIndex) => {
          btn.classList.toggle("active-step", btnIndex === index);
        });

        if (step?.scrollIntoView) {
          step.scrollIntoView({ behavior: "smooth", block: "nearest", inline: "center" });
        }

        const activeCard = lineCardElements[index];
        if (activeCard) {
          const select = activeCard.querySelector("select[data-role='heads']");
          if (select) {
            setTimeout(() => select.focus({ preventScroll: false }), 30);
          }
        }
      }

      function handleLineClear(startIndex) {
        for (let i = startIndex; i < lineCardElements.length; i += 1) {
          const card = lineCardElements[i];
          resetLineCard(card, { clearSelection: i !== startIndex, resetStep: true });
          const step = lineStepButtons[i];
          if (step) {
            step.disabled = i !== startIndex;
            step.classList.remove("completed-step", "has-change", "active-step");
            const statusSpan = step.querySelector(".step-status");
            if (statusSpan) {
              statusSpan.textContent = "Awaiting toss";
            }
          }
        }

        activateLineByIndex(startIndex);
        updateProgress();
      }

      function simulateToss() {
        let heads = 0;
        for (let i = 0; i < 3; i += 1) {
          heads += Math.random() < 0.5 ? 0 : 1;
        }
        return heads;
      }

      function updateProgress() {
        const selects = Array.from(document.querySelectorAll("select[data-role='heads']"));
        const completed = selects.filter((select) => select.value !== "").length;
        const percent = (completed / totalLines) * 100;

        if (progressLabel) {
          progressLabel.textContent =
            completed === totalLines
              ? "All lines set — ready to reveal"
              : `${completed} / ${totalLines} lines set`;
        }

        if (progressBar) {
          progressBar.style.width = `${percent}%`;
          progressBar.classList.toggle("complete", completed === totalLines);
        }

        if (progressTrack) {
          progressTrack.setAttribute("aria-valuenow", String(completed));
          progressTrack.setAttribute(
            "aria-valuetext",
            completed === totalLines ? "Complete" : `${completed} of ${totalLines} lines`
          );
        }

        calculateButton.disabled = completed !== totalLines;
      }

      function buildLineCards() {
        lineInputsContainer.innerHTML = "";
        lineTimeline.innerHTML = "";
        lineCardElements = [];
        lineStepButtons = [];

        lineOrder.forEach((lineNumber, index) => {
          const card = createLineCard({ lineNumber, tooltip: lineTooltips[lineNumber] });
          card.dataset.index = String(index);
          card.dataset.completed = "false";
          lineInputsContainer.appendChild(card);
          lineCardElements.push(card);

          const stepButton = document.createElement("button");
          stepButton.type = "button";
          stepButton.className = "line-step";
          stepButton.dataset.index = String(index);
          stepButton.dataset.lineNumber = String(lineNumber);
          stepButton.innerHTML = `
            <span class="step-label">Line ${lineNumber}</span>
            <span class="step-role">${lineRoles[lineNumber]}</span>
            <span class="step-status">Awaiting toss</span>
          `;
          stepButton.disabled = index !== 0;
          stepButton.addEventListener("click", () => {
            if (!stepButton.disabled) {
              activateLineByIndex(index);
            }
          });
          lineTimeline.appendChild(stepButton);
          lineStepButtons.push(stepButton);

          resetLineCard(card, { resetStep: true });
        });

        currentLineIndex = 0;
        activateLineByIndex(0);
        updateProgress();
      }

      function collectLineData() {
        const cards = Array.from(document.querySelectorAll(".line-card"));
        const data = [];

        for (let i = cards.length - 1; i >= 0; i -= 1) {
          const card = cards[i];
          const select = card.querySelector("select");
          if (!select.value) {
            const lineNumber = card.dataset.lineNumber;
            throw new Error(`Please set the heads count for Line ${lineNumber}.`);
          }
          const heads = Number(select.value);
          const tails = 3 - heads;
          const sum = heads * 3 + tails * 2;
          const isSolid = sum % 2 === 1;
          const isChanging = sum === 6 || sum === 9;
          const nextIsSolid = sum === 6 ? true : sum === 9 ? false : isSolid;

          data.push({
            lineNumber: Number(card.dataset.lineNumber),
            heads,
            tails,
            sum,
            isSolid,
            isChanging,
            nextIsSolid
          });
        }
        data.sort((a, b) => a.lineNumber - b.lineNumber);
        return data;
      }

      function getTrigramIndex(lines, startIndex, useNext = false) {
        let value = 0;
        for (let offset = 0; offset < 3; offset += 1) {
          const line = lines[startIndex + offset];
          const isYang = useNext ? line.nextIsSolid : line.isSolid;
          if (isYang) {
            value |= 1 << offset;
          }
        }
        const index = trigramMap[value];
        if (index === undefined) {
          throw new Error("Invalid trigram combination encountered.");
        }
        return index;
      }

      function getHexagram(lines, useNext = false) {
        const lowerIndex = getTrigramIndex(lines, 0, useNext);
        const upperIndex = getTrigramIndex(lines, 3, useNext);

        const baseInfo = hexagramChart[lowerIndex][upperIndex];
        const detail = hexagramDetails[baseInfo.number] || {
          judgment: "Consult your I Ching reference for full meaning.",
          image: "Guidance unavailable in summary."
        };

        return {
          number: baseInfo.number,
          name: baseInfo.name,
          judgment: detail.judgment,
          image: detail.image,
          lines: lines.map((line) => ({
            isSolid: useNext ? line.nextIsSolid : line.isSolid,
            isChanging: !useNext && line.isChanging
          }))
        };
      }

      function renderLineSummary(lines) {
        const wrapper = document.createElement("div");
        wrapper.className = "line-grid";

        for (let i = lines.length - 1; i >= 0; i -= 1) {
          const line = lines[i];
          const row = document.createElement("div");
          row.className = "line-row";
          if (line.isChanging) {
            row.classList.add("changing");
          }

          const label = document.createElement("div");
          label.innerHTML = `<strong>Line ${line.lineNumber}</strong><div>${lineRoles[line.lineNumber]}</div>`;

          const sum = document.createElement("div");
          sum.textContent = `Sum ${line.sum}`;

          const counts = document.createElement("div");
          counts.textContent = `${line.heads} heads / ${line.tails} tails`;

          const nature = document.createElement("div");
          nature.textContent = line.isSolid ? "Yang (solid)" : "Yin (broken)";

          const change = document.createElement("div");
          change.textContent = line.isChanging
            ? line.sum === 6
              ? "Changing — old yin → yang"
              : "Changing — old yang → yin"
            : "Static line";

          row.append(label, sum, counts, nature, change);
          wrapper.appendChild(row);
        }

        lineSummarySection.innerHTML = "";
        lineSummarySection.innerHTML = "<h2>Line Analysis</h2>";
        lineSummarySection.appendChild(wrapper);
      }

      function renderHexagramCard({ label, hexagram, lineData = [], isRelating = false }) {
        const card = document.createElement("article");
        card.className = "hexagram-card";
        card.dataset.hexagramNumber = String(hexagram.number);

        const title = document.createElement("h2");
        title.textContent = label;

        const diagram = document.createElement("div");
        diagram.className = "hexagram-diagram";
        const changingLineNumbers = new Set(
          (lineData || []).filter((line) => line.isChanging).map((line) => line.lineNumber)
        );

        for (let i = hexagram.lines.length - 1; i >= 0; i -= 1) {
          const line = hexagram.lines[i];
          const lineDiv = document.createElement("div");
          const isSolid = line.isSolid;
          lineDiv.className = `hexagram-line ${isSolid ? "solid" : "broken"}`;
          const lineNumber = i + 1;
          const isChangingLine = line.isChanging || (isRelating && changingLineNumbers.has(lineNumber));
          if (isChangingLine) {
            lineDiv.classList.add("changing");
          }
          const ariaParts = [line.isSolid ? "Yang line" : "Yin line"];
          if (isChangingLine) {
            ariaParts.push("changing");
          }
          lineDiv.setAttribute("aria-label", ariaParts.join(" · "));
          diagram.appendChild(lineDiv);
        }

        const info = document.createElement("div");
        info.className = "hexagram-info";
        const heading = document.createElement("h3");
        heading.textContent = `${hexagram.number} – ${hexagram.name}`;
        const judgment = document.createElement("p");
        judgment.innerHTML = `<strong>Judgment:</strong> ${hexagram.judgment}`;
        const image = document.createElement("p");
        image.innerHTML = `<strong>Image:</strong> ${hexagram.image}`;
        info.append(heading, judgment, image);

        card.append(title, diagram, info);

        const fullText = (window.hexagramTexts && window.hexagramTexts[hexagram.number]) || null;
        const introText = fullText && typeof fullText.intro === "string" ? fullText.intro.trim() : "";
        const judgmentText =
          fullText && typeof fullText.judgment === "string" && fullText.judgment.trim().length > 0
            ? fullText.judgment.trim()
            : hexagram.judgment;
        const imageText =
          fullText && typeof fullText.image === "string" && fullText.image.trim().length > 0
            ? fullText.image.trim()
            : hexagram.image;
        const lineTexts =
          (fullText && Array.isArray(fullText.lines) ? fullText.lines.filter((line) => line && line.trim().length > 0) : []) ||
          [];
        const hasFullContent = Boolean(introText || judgmentText || imageText || lineTexts.length > 0);

        if (hasFullContent) {
          const fulltextDetails = document.createElement("details");
          fulltextDetails.className = "hexagram-fulltext";
          const summary = document.createElement("summary");
          summary.textContent = "Read the full text";
          summary.setAttribute("aria-label", "Read the full text");
          fulltextDetails.appendChild(summary);

          const body = document.createElement("div");
          body.className = "fulltext-body";

          if (introText) {
            const introSection = document.createElement("div");
            introSection.className = "fulltext-section";
            introSection.innerHTML = `<strong>Intro:</strong><div>${introText}</div>`;
            body.appendChild(introSection);
          }

          if (judgmentText) {
            const judgmentSection = document.createElement("div");
            judgmentSection.className = "fulltext-section";
            judgmentSection.innerHTML = `<strong>Judgment:</strong><div>${judgmentText}</div>`;
            body.appendChild(judgmentSection);
          }

          if (imageText) {
            const imageSection = document.createElement("div");
            imageSection.className = "fulltext-section";
            imageSection.innerHTML = `<strong>Image:</strong><div>${imageText}</div>`;
            body.appendChild(imageSection);
          }

          if (lineTexts.length > 0) {
            const linesSection = document.createElement("div");
            linesSection.className = "fulltext-section";
            const list = document.createElement("ol");
            list.className = "line-text-list";
            lineTexts.forEach((lineText, index) => {
              const li = document.createElement("li");
              li.className = "line-text-entry";
              const lineNumber = index + 1;
              if (changingLineNumbers.has(lineNumber)) {
                li.classList.add("line-change");
              }
              li.textContent = lineText;
              list.appendChild(li);
            });
            linesSection.innerHTML = "<strong>Lines:</strong>";
            linesSection.appendChild(list);
            body.appendChild(linesSection);
          }

          fulltextDetails.appendChild(body);
          card.appendChild(fulltextDetails);
        }

        return card;
      }

      function renderHexagramReference() {
        const table = document.getElementById("hexagramReferenceTable");
        if (!table) return;

        table.innerHTML = "";

        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        const cornerCell = document.createElement("th");
        cornerCell.className = "reference-corner";
        cornerCell.scope = "col";
        cornerCell.textContent = "Lower ↓ / Upper →";
        headerRow.appendChild(cornerCell);

        trigramInfo.forEach((trigram) => {
          const th = document.createElement("th");
          th.scope = "col";
          th.innerHTML = `
            <div class="reference-heading">
              <span class="trigram-symbol" aria-hidden="true">${trigram.symbol}</span>
              <span>
                ${trigram.name}
                <small>${trigram.english}</small>
              </span>
            </div>
          `;
          th.setAttribute("aria-label", `${trigram.name}, ${trigram.english}, upper trigram`);
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);

        const tbody = document.createElement("tbody");
        hexagramChart.forEach((row, lowerIndex) => {
          const tr = document.createElement("tr");
          const trigram = trigramInfo[lowerIndex];
          const rowHeader = document.createElement("th");
          rowHeader.scope = "row";
          rowHeader.innerHTML = `
            <div class="reference-heading">
              <span class="trigram-symbol" aria-hidden="true">${trigram.symbol}</span>
              <span>
                ${trigram.name}
                <small>${trigram.english}</small>
              </span>
            </div>
          `;
          rowHeader.setAttribute("aria-label", `${trigram.name}, ${trigram.english}, lower trigram`);
          tr.appendChild(rowHeader);

          row.forEach((hex, upperIndex) => {
            const cell = document.createElement("td");
            const [classicalName, modernName] = hex.name.split("/").map((part) => part.trim());
            cell.innerHTML = `
              <div class="reference-cell">
                <strong>${hex.number}</strong>
                <span>${modernName || classicalName}</span>
              </div>
            `;
            cell.setAttribute(
              "aria-label",
              `Hexagram ${hex.number}, ${hex.name}, lower ${trigramInfo[lowerIndex].english}, upper ${trigramInfo[upperIndex].english}`
            );
            tr.appendChild(cell);
          });
          tbody.appendChild(tr);
        });

        table.append(thead, tbody);
      }

      function formatHexagramTitle(hexagram) {
        if (!hexagram) return "";
        const [classicalName, modernName] = hexagram.name.split("/").map((part) => part.trim());
        return `${hexagram.number} – ${modernName || classicalName}`;
      }

      function buildReadingPayload({ lines, primaryHexagram, relatedHexagram }) {
        return {
          timestamp: new Date().toISOString(),
          lines,
          primaryHexagram,
          relatedHexagram,
          hasChanges: Boolean(relatedHexagram),
          url: window.location.href.split("#")[0]
        };
      }

      function presentReading(reading, { scrollIntoView = true } = {}) {
        if (!reading) return;

        renderLineSummary(reading.lines);
          hexagramDisplay.innerHTML = "";
          hexagramDisplay.appendChild(
          renderHexagramCard({
            label: "Primary Hexagram",
            hexagram: reading.primaryHexagram,
            lineData: reading.lines,
            isRelating: false
          })
        );

        if (reading.relatedHexagram) {
            hexagramDisplay.appendChild(
            renderHexagramCard({
              label: "Relating Hexagram",
              hexagram: reading.relatedHexagram,
              lineData: reading.lines,
              isRelating: true
            })
            );
            secondaryNote.hidden = true;
            secondaryNote.textContent = "";
          } else {
            secondaryNote.hidden = false;
            secondaryNote.textContent = "Static hexagram—no relating changes.";
          }

          resultsSection.classList.add("active");
        if (shareButton) {
          shareButton.disabled = false;
        }
        if (shareFeedback) {
          shareFeedback.hidden = true;
          shareFeedback.textContent = "";
        }
        currentReading = reading;

        if (scrollIntoView) {
          resultsSection.scrollIntoView({ behavior: "smooth", block: "start" });
        }
      }

      function formatRelativeTime(isoString) {
        if (!isoString) return "";
        const then = new Date(isoString);
        if (Number.isNaN(then.getTime())) return "";

        const now = new Date();
        const diffMs = now - then;
        const diffMinutes = Math.round(diffMs / 60000);

        if (diffMinutes < 1) return "Just now";
        if (diffMinutes < 60) return `${diffMinutes} minute${diffMinutes === 1 ? "" : "s"} ago`;

        const diffHours = Math.round(diffMinutes / 60);
        if (diffHours < 24) return `${diffHours} hour${diffHours === 1 ? "" : "s"} ago`;

        return then.toLocaleDateString(undefined, {
          month: "short",
          day: "numeric",
          hour: "numeric",
          minute: "2-digit"
        });
      }

      function updateLastReadingUI(reading) {
        if (!heroGlass || !lastReadingPreview) return;

        if (!reading) {
          lastReadingPreview.innerHTML =
            "<p>Each reading auto-saves so you can revisit it later today.</p>";
          if (lastReadingButton) {
            lastReadingButton.hidden = true;
          }
          heroGlass.classList.remove("has-reading");
          return;
        }

        const primaryTitle = formatHexagramTitle(reading.primaryHexagram);
        const relatingTitle = reading.relatedHexagram
          ? formatHexagramTitle(reading.relatedHexagram)
          : null;
        const timeLabel = formatRelativeTime(reading.timestamp);

        lastReadingPreview.innerHTML = `
          <p class="hero-glass-primary">
            <strong>${primaryTitle}</strong>
            ${
              relatingTitle
                ? `<span class="hero-glass-arrow" aria-hidden="true">→</span><span>${relatingTitle}</span>`
                : `<span class="hero-glass-static">Static hexagram</span>`
            }
          </p>
          <p class="hero-glass-meta">${timeLabel || "Saved for today"}</p>
        `;

        if (lastReadingButton) {
          lastReadingButton.hidden = false;
        }
        heroGlass.classList.add("has-reading");
      }

      function saveReading(reading) {
        try {
          localStorage.setItem(STORAGE_KEY, JSON.stringify(reading));
          updateLastReadingUI(reading);
        } catch (error) {
          console.warn("Unable to save reading:", error);
        }
      }

      function loadStoredReading() {
        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (!stored) return null;
          return JSON.parse(stored);
        } catch (error) {
          console.warn("Unable to load stored reading:", error);
          return null;
        }
      }

      function parseReadingFromUrl() {
        try {
          const params = new URLSearchParams(window.location.search);
          const encoded = params.get("reading");
          if (!encoded) return null;
          const reading = decodeReadingPayload(encoded);
          return reading;
        } catch (error) {
          console.warn("Unable to parse shared reading:", error);
          return null;
        }
      }

      function buildShareData(reading) {
        if (!reading) return null;
        const primaryTitle = formatHexagramTitle(reading.primaryHexagram);
        const relatedTitle = reading.relatedHexagram
          ? formatHexagramTitle(reading.relatedHexagram)
          : null;
        const url = createShareUrl(reading);

        const bodyLines = [
          relatedTitle
            ? `I just cast ${primaryTitle}, changing to ${relatedTitle}.`
            : `I just cast ${primaryTitle}—a static hexagram.`,
          "Read yours with the TrueSight I Ching Oracle:"
        ];

        return {
          title: primaryTitle,
          text: `${bodyLines.join(" ")} ${url}`,
          url,
          clipboardText: `${bodyLines.join("\n")}\n${url}`
        };
      }

      async function shareCurrentReading() {
        const reading = currentReading || loadStoredReading();
        if (!reading || !shareFeedback) return;

        const shareData = buildShareData(reading);
        if (!shareData) return;

        shareFeedback.hidden = true;
        shareFeedback.textContent = "";

        if (navigator.share) {
          try {
            await navigator.share({
              title: shareData.title,
              text: shareData.text,
              url: shareData.url
            });
            shareFeedback.textContent = "Shared successfully.";
            shareFeedback.hidden = false;
            return;
          } catch (error) {
            if (error && error.name === "AbortError") {
              return;
            }
            console.warn("Web Share failed, falling back to clipboard:", error);
          }
        }

        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(shareData.clipboardText);
            shareFeedback.textContent = "Link copied—ready to share.";
          } else {
            shareFeedback.textContent = `Share this link: ${shareData.url}`;
          }
        } catch (error) {
          shareFeedback.textContent = `Share this link: ${shareData.url}`;
        }

        shareFeedback.hidden = false;
      }

      function handleCalculate() {
        try {
          const lines = collectLineData();
          const primaryHexagram = getHexagram(lines);
          const hasChanges = lines.some((line) => line.isChanging);
          let relatedHexagram = null;

          if (hasChanges) {
            relatedHexagram = getHexagram(lines, true);
          }

          const reading = buildReadingPayload({ lines, primaryHexagram, relatedHexagram });
          presentReading(reading);
          saveReading(reading);
        } catch (error) {
          alert(error.message);
        }
      }

      function handleReset() {
        resultsSection.classList.remove("active");
        hexagramDisplay.innerHTML = "";
        lineSummarySection.innerHTML = "";
        secondaryNote.hidden = true;
        secondaryNote.textContent = "";
        if (shareButton) {
          shareButton.disabled = true;
        }
        if (shareFeedback) {
          shareFeedback.hidden = true;
          shareFeedback.textContent = "";
        }
        currentReading = null;
        buildLineCards();
      }

      if (shareButton) {
        shareButton.addEventListener("click", () => {
          shareCurrentReading();
        });
      }

      if (beginCastingButton) {
        beginCastingButton.addEventListener("click", () => {
          const castingShell = document.querySelector(".casting-shell");
          if (castingShell) {
            castingShell.scrollIntoView({ behavior: "smooth", block: "start" });
          }
          activateLineByIndex(0);
        });
      }

      if (lastReadingButton) {
        lastReadingButton.addEventListener("click", () => {
          const reading = loadStoredReading();
          if (!reading) return;
          presentReading(reading);
        });
      }

      calculateButton.addEventListener("click", handleCalculate);
      if (tossAllButton) {
        tossAllButton.addEventListener("click", () => {
          handleReset();
          lineOrder.forEach((_, index) => {
            const card = lineCardElements[index];
            if (!card) return;
            const select = card.querySelector("select[data-role='heads']");
            const heads = simulateToss();
            if (select) {
              select.value = heads.toString();
            }
            updateLineResult(card, heads, { userSelected: false });
          });
          handleCalculate();
        });
      }
      resetButton.addEventListener("click", handleReset);

      renderHexagramReference();
      buildLineCards();

      const storedReading = loadStoredReading();
      const sharedReading = parseReadingFromUrl();

      if (sharedReading) {
        presentReading(sharedReading, { scrollIntoView: false });
        saveReading(sharedReading);
        try {
          const cleanUrl = `${window.location.origin}${window.location.pathname}${window.location.hash || ""}`;
          window.history.replaceState({}, document.title, cleanUrl);
        } catch (error) {
          console.warn("Unable to clean shared URL:", error);
        }
      } else {
        updateLastReadingUI(storedReading);
      }
    </script>
  </body>
</html>

