<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>I Ching Hexagram Calculator</title>
    <style>
      :root {
        color-scheme: light;
        --bg: #f9f4ee;
        --bg-strong: #fffdf9;
        --panel: rgba(255, 255, 255, 0.82);
        --ink: #24160b;
        --ink-soft: #5e4632;
        --accent: #b9894c;
        --accent-strong: #8f6124;
        --accent-soft: rgba(185, 137, 76, 0.18);
        --border: rgba(36, 22, 11, 0.18);
        --shadow: 0 32px 70px rgba(46, 32, 20, 0.14);
        --radius-lg: 28px;
        --radius-md: 18px;
        --radius-sm: 12px;
        --transition: 220ms ease;
        font-synthesis: none;
        text-rendering: optimizeLegibility;
        font-family: "Inter", "Segoe UI", "Helvetica Neue", Arial, sans-serif;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        justify-content: center;
        padding: 40px 18px 48px;
        background: radial-gradient(circle at top, rgba(255, 255, 255, 0.92) 0%, var(--bg) 55%, #efe3d4 100%);
        color: var(--ink);
      }

      main {
        width: min(1040px, 100%);
        background: var(--panel);
        backdrop-filter: blur(12px);
        border: 1px solid var(--border);
        border-radius: var(--radius-lg);
        padding: clamp(24px, 4vw, 48px);
        box-shadow: var(--shadow);
        display: grid;
        gap: clamp(24px, 4vw, 40px);
      }

      header {
        display: grid;
        gap: 12px;
        text-align: center;
      }

      h1 {
        margin: 0;
        font-size: clamp(2rem, 3vw, 2.7rem);
        font-weight: 700;
        letter-spacing: -0.02em;
        color: var(--accent-strong);
      }

      p.lead {
        margin: 0 auto;
        max-width: 52ch;
        line-height: 1.65;
        color: var(--ink-soft);
        font-size: clamp(0.98rem, 1.6vw, 1.1rem);
      }

      .overview {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 18px;
      }

      .overview-card {
        background: var(--bg-strong);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 18px 20px;
        display: grid;
        gap: 10px;
      }

      .overview-card.highlight {
        background: linear-gradient(135deg, rgba(185, 137, 76, 0.18), rgba(255, 255, 255, 0.88));
        border-color: rgba(185, 137, 76, 0.3);
      }

      .overview-card h2 {
        margin: 0;
        font-size: 1.05rem;
        color: var(--accent-strong);
        letter-spacing: 0.01em;
      }

      .guide-list {
        margin: 0;
        padding-left: 20px;
        display: grid;
        gap: 6px;
        color: var(--ink-soft);
        font-size: 0.95rem;
        line-height: 1.5;
      }

      .progress-area {
        background: var(--bg-strong);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        padding: 18px 20px;
        display: grid;
        gap: 12px;
      }

      .progress-heading {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        font-size: 0.95rem;
        color: var(--ink-soft);
      }

      .progress-heading strong {
        font-size: 1rem;
        color: var(--ink);
      }

      .progress-track {
        position: relative;
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: rgba(36, 22, 11, 0.08);
        overflow: hidden;
      }

      .progress-indicator {
        position: absolute;
        inset: 0;
        width: 0%;
        background: linear-gradient(90deg, var(--accent) 0%, var(--accent-strong) 100%);
        transition: width var(--transition);
      }

      .progress-indicator.complete::after {
        content: "";
        position: absolute;
        inset: 0;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.35), transparent);
        mix-blend-mode: screen;
      }

      .line-flow {
        display: grid;
        gap: 18px;
      }

      .line-steps {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .line-step {
        display: grid;
        gap: 4px;
        padding: 14px 16px;
        border-radius: var(--radius-md);
        border: 1px solid rgba(36, 22, 11, 0.12);
        background: rgba(255, 255, 255, 0.85);
        color: var(--ink);
        text-align: left;
        cursor: pointer;
        transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
        font: inherit;
      }

      .line-step:not(:disabled):hover {
        transform: translateY(-2px);
        box-shadow: 0 12px 24px rgba(36, 22, 11, 0.12);
      }

      .line-step:disabled {
        cursor: not-allowed;
        opacity: 0.45;
        transform: none;
      }

      .line-step .step-label {
        font-weight: 600;
      }

      .line-step .step-role {
        font-size: 0.82rem;
        color: var(--ink-soft);
      }

      .line-step .step-status {
        font-size: 0.78rem;
        color: rgba(36, 22, 11, 0.65);
      }

      .line-step.active-step {
        border-color: rgba(185, 137, 76, 0.55);
        box-shadow: 0 12px 24px rgba(185, 137, 76, 0.18);
        transform: translateY(-2px);
      }

      .line-step.completed-step {
        border-color: rgba(36, 22, 11, 0.3);
      }

      .line-step.has-change {
        border-color: rgba(185, 137, 76, 0.55);
        background: linear-gradient(140deg, rgba(185, 137, 76, 0.16), rgba(255, 255, 255, 0.92));
      }

      .line-inputs {
        position: relative;
        min-height: 220px;
      }

      .line-card {
        display: none;
        gap: 14px;
        padding: 18px;
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--bg-strong);
        transition: border-color var(--transition), box-shadow var(--transition), transform var(--transition);
      }

      .line-card.active-line {
        display: grid;
      }

      .line-card.active-line:hover {
        transform: translateY(-3px);
        box-shadow: 0 16px 32px rgba(36, 22, 11, 0.12);
      }

      .line-card.active-line:focus-within {
        border-color: rgba(185, 137, 76, 0.6);
        transform: translateY(-2px);
        box-shadow: 0 18px 34px rgba(36, 22, 11, 0.16);
      }

      .line-card.completed {
        border-color: rgba(36, 22, 11, 0.22);
        box-shadow: 0 14px 28px rgba(36, 22, 11, 0.1);
      }

      .line-card.has-change {
        border-color: rgba(185, 137, 76, 0.6);
        background: linear-gradient(160deg, rgba(185, 137, 76, 0.16), rgba(255, 255, 255, 0.92));
      }

      .line-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
      }

      .line-meta {
        display: grid;
        gap: 2px;
      }

      .line-name {
        font-weight: 600;
        letter-spacing: 0.01em;
      }

      .line-role {
        font-size: 0.86rem;
        color: var(--ink-soft);
      }

      .line-preview {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .mini-line {
        width: 78px;
        height: 14px;
        border-radius: 7px;
        background: rgba(36, 22, 11, 0.12);
        position: relative;
        overflow: hidden;
        transition: background var(--transition), transform var(--transition);
      }

      .mini-line.solid {
        background: rgba(36, 22, 11, 0.9);
      }

      .mini-line.broken {
        background: linear-gradient(
          to right,
          rgba(36, 22, 11, 0.85) 0%,
          rgba(36, 22, 11, 0.85) 32%,
          transparent 32%,
          transparent 68%,
          rgba(36, 22, 11, 0.85) 68%,
          rgba(36, 22, 11, 0.85) 100%
        );
      }

      .mini-line.changing {
        box-shadow: 0 0 0 2px rgba(185, 137, 76, 0.35);
      }

      .line-detail-text {
        font-size: 0.85rem;
        color: var(--ink-soft);
      }

      .controls {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
      }

      select {
        padding: 8px 12px;
        border-radius: var(--radius-sm);
        border: 1px solid rgba(36, 22, 11, 0.22);
        background: white;
        font-size: 1rem;
        min-width: 140px;
        color: var(--ink);
        transition: border-color var(--transition), box-shadow var(--transition);
      }

      select:focus {
        outline: none;
        border-color: var(--accent-strong);
        box-shadow: 0 0 0 3px rgba(185, 137, 76, 0.24);
      }

      button {
        padding: 11px 18px;
        border-radius: 999px;
        border: none;
        background: var(--accent-strong);
        color: white;
        cursor: pointer;
        font-weight: 600;
        letter-spacing: 0.01em;
        transition: transform var(--transition), box-shadow var(--transition), background var(--transition);
      }

      button:hover {
        transform: translateY(-2px);
        box-shadow: 0 18px 32px rgba(143, 97, 36, 0.28);
      }

      button:disabled {
        cursor: not-allowed;
        opacity: 0.42;
        box-shadow: none;
        transform: none;
      }

      button.secondary {
        background: rgba(36, 22, 11, 0.76);
      }

      button.ghost {
        background: transparent;
        color: var(--accent-strong);
        border: 1px solid rgba(185, 137, 76, 0.4);
        box-shadow: none;
      }

      button.ghost:hover {
        background: rgba(185, 137, 76, 0.08);
        transform: none;
      }

      .tooltip {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 22px;
        height: 22px;
        border-radius: 50%;
        background: rgba(36, 22, 11, 0.15);
        color: var(--accent-strong);
        font-size: 0.78rem;
        font-weight: 600;
        cursor: help;
      }

      .actions {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        justify-content: center;
      }

      #results {
        display: none;
        gap: 20px;
      }

      #results.active {
        display: grid;
      }

      .line-summary {
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        background: var(--bg-strong);
        padding: 22px;
        display: grid;
        gap: 16px;
      }

      .line-summary h2 {
        margin: 0;
        font-size: 1.15rem;
        color: var(--accent-strong);
      }

      .line-grid {
        display: grid;
        gap: 12px;
      }

      .line-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 12px;
        padding: 12px 14px;
        border-radius: var(--radius-sm);
        background: rgba(36, 22, 11, 0.08);
        align-items: center;
      }

      .line-row.changing {
        background: var(--accent-soft);
        border: 1px solid rgba(185, 137, 76, 0.36);
      }

      .line-row strong {
        color: var(--ink);
      }

      .hexagram-section {
        display: grid;
        gap: 18px;
      }

      .hexagram-layout {
        display: grid;
        gap: 18px;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      }

      .hexagram-card {
        border-radius: var(--radius-md);
        border: 1px solid var(--border);
        background: var(--bg-strong);
        padding: 22px;
        display: grid;
        gap: 16px;
        box-shadow: 0 12px 24px rgba(36, 22, 11, 0.08);
      }

      .hexagram-card h2 {
        margin: 0;
        color: var(--accent-strong);
        font-size: 1.1rem;
      }

      .hexagram-diagram {
        display: grid;
        gap: 10px;
      }

      .hexagram-line {
        position: relative;
        height: 22px;
        border-radius: 6px;
        background: rgba(36, 22, 11, 0.12);
        overflow: hidden;
      }

      .hexagram-line.solid {
        background: rgba(36, 22, 11, 0.88);
      }

      .hexagram-line.broken {
        background: linear-gradient(
          to right,
          rgba(36, 22, 11, 0.88) 0%,
          rgba(36, 22, 11, 0.88) 33%,
          transparent 33%,
          transparent 67%,
          rgba(36, 22, 11, 0.88) 67%,
          rgba(36, 22, 11, 0.88) 100%
        );
      }

      .hexagram-line.changing {
        box-shadow: 0 0 0 3px rgba(185, 137, 76, 0.4);
      }

      .hexagram-info h3 {
        margin: 0;
        font-size: 1.06rem;
        color: var(--ink);
      }

      .hexagram-info p {
        margin: 0;
        line-height: 1.6;
        color: var(--ink-soft);
        font-size: 0.95rem;
      }

      #secondaryNote {
        margin: 0;
        font-size: 0.95rem;
        color: var(--ink-soft);
        text-align: center;
      }

      footer {
        text-align: center;
        font-size: 0.85rem;
        color: var(--ink-soft);
      }

      footer strong {
        color: var(--accent-strong);
      }

      @media (max-width: 720px) {
        body {
          padding: 24px 14px 32px;
        }

        main {
          gap: 28px;
        }

        .overview {
          grid-template-columns: 1fr;
        }

        .line-steps {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        }

        .actions {
          flex-direction: column;
        }

        button,
        button.ghost,
        button.secondary {
          width: 100%;
        }
      }

      @media (max-width: 480px) {
        body {
          padding: 18px 12px 28px;
          background: linear-gradient(180deg, rgba(255, 255, 255, 0.95) 0%, var(--bg) 100%);
        }

        main {
          padding: 22px 18px;
          border-radius: 22px;
          gap: 24px;
        }

        h1 {
          font-size: clamp(1.65rem, 6vw, 2rem);
        }

        p.lead {
          font-size: 0.98rem;
          text-align: left;
        }

        .overview-card,
        .progress-area,
        .line-card,
        .line-summary,
        .hexagram-card {
          padding: 16px;
        }

        .line-card {
          gap: 12px;
        }

        .line-top {
          flex-direction: column;
          gap: 6px;
        }

        .line-steps {
          grid-template-columns: 1fr;
        }

        .line-role {
          font-size: 0.82rem;
        }

        .controls {
          flex-direction: column;
          align-items: stretch;
        }

        select,
        .controls button {
          width: 100%;
        }

        .mini-line {
          width: 100%;
          height: 16px;
        }

        .line-grid,
        .hexagram-layout {
          gap: 14px;
        }

        .line-row {
          grid-template-columns: 1fr;
          gap: 6px;
          padding: 12px;
        }

        .hexagram-layout {
          grid-template-columns: 1fr;
        }

        .hexagram-info p,
        .hexagram-info h3 {
          font-size: 0.95rem;
        }

        .progress-area {
          position: sticky;
          top: 12px;
          z-index: 2;
          box-shadow: 0 12px 24px rgba(36, 22, 11, 0.12);
        }

        .actions {
          position: sticky;
          bottom: 12px;
          gap: 10px;
          background: rgba(249, 244, 238, 0.92);
          padding: 14px 16px;
          border-radius: 18px;
          box-shadow: 0 16px 28px rgba(36, 22, 11, 0.12);
        }

        footer {
          font-size: 0.82rem;
          text-align: left;
        }
      }
    </style>
  </head>
  <body>
    <main>
      <header>
        <h1>I Ching Daily Guidance</h1>
        <p class="lead">
          Generate your daily hexagram using the Wilhelm/Baynes three-coin method.
          Choose the heads count for each line or let the oracle toss for you.
        </p>
      </header>

      <section class="overview" aria-label="Casting guidance">
        <article class="overview-card">
          <h2>Preparing Your Cast</h2>
          <ul class="guide-list">
            <li>Work from the bottom line upward—Line 1 anchors the hexagram.</li>
            <li>Each coin toss produces 0–3 heads. Tails are counted automatically.</li>
            <li>Solid lines represent yang (movement); broken lines show yin (receptive).</li>
          </ul>
        </article>
        <article class="overview-card highlight">
          <h2>Coin Method Quick Math</h2>
          <ul class="guide-list">
            <li>Heads count as 3, tails count as 2—sum to find each line.</li>
            <li>6 = old yin (changing to yang); 7 = young yang; 8 = young yin; 9 = old yang (changing to yin).</li>
            <li>Changing lines reveal a relating hexagram—trace both for nuance.</li>
          </ul>
        </article>
      </section>

      <section class="progress-area" aria-live="polite">
        <div class="progress-heading">
          <strong>Line Progress</strong>
          <span id="progressLabel">0 / 6 lines set</span>
        </div>
        <div class="progress-track" role="progressbar" aria-valuemin="0" aria-valuemax="6" aria-valuenow="0">
          <div class="progress-indicator" id="progressBar"></div>
        </div>
      </section>

      <section class="line-flow">
        <nav class="line-steps" id="lineTimeline" aria-label="Line sequence"></nav>
        <section class="line-inputs" id="lineInputs" aria-label="Line inputs"></section>
      </section>

      <div class="actions">
        <button id="tossAll" class="ghost" type="button">Toss All Lines</button>
        <button id="calculate" type="button" disabled>Reveal Guidance</button>
        <button id="reset" class="secondary" type="button">New Reading</button>
      </div>

      <section id="results">
        <article class="line-summary" aria-live="polite"></article>
        <section class="hexagram-section">
          <div class="hexagram-layout" id="hexagramDisplay"></div>
          <p id="secondaryNote" hidden></p>
        </section>
      </section>

      <footer>
        <strong>Note:</strong> Lines highlighted in amber indicate changing energy—flip them to unveil the relating hexagram.
      </footer>
    </main>

    <script>
      const totalLines = 6;
      const headsOptions = [
        { value: "", label: "Select heads" },
        { value: "0", label: "0 heads (3 tails)" },
        { value: "1", label: "1 head (2 tails)" },
        { value: "2", label: "2 heads (1 tail)" },
        { value: "3", label: "3 heads (0 tails)" }
      ];

      const lineTooltips = {
        1: "Line 1 (bottom): Foundation—how you begin.",
        2: "Line 2: Inner movement—align actions carefully.",
        3: "Line 3: Transition—watch for obstacles.",
        4: "Line 4: Outer movement—bridging to the world.",
        5: "Line 5: Leadership—center of influence.",
        6: "Line 6 (top): Completion—how things conclude."
      };

      const lineRoles = {
        1: "Foundation — Earthly base",
        2: "Inner support — Align within",
        3: "Threshold — Crossroads energy",
        4: "Outreach — Bridge to others",
        5: "Heart — Guiding influence",
        6: "Culmination — Release outcome"
      };

      const lineNatureDescriptions = {
        6: "6 — old yin transforms to yang",
        7: "7 — young yang holds firm",
        8: "8 — young yin stays open",
        9: "9 — old yang transforms to yin"
      };

      const trigramMap = {
        "111": 0,
        "100": 1,
        "010": 2,
        "001": 3,
        "000": 4,
        "101": 5,
        "110": 6,
        "011": 7
      };

      const hexagramChart = [
        [
          { number: 1, name: "Ch'ien / The Creative" },
          { number: 34, name: "Ta Chuang / The Power of the Great" },
          { number: 5, name: "Hsü / Waiting" },
          { number: 26, name: "Ta Ch'u / The Taming Power of the Great" },
          { number: 11, name: "T'ai / Peace" },
          { number: 9, name: "Hsiao Ch'u / The Taming Power of the Small" },
          { number: 14, name: "Ta Yu / Possession in Great Measure" },
          { number: 43, name: "Kuai / Break-through" }
        ],
        [
          { number: 25, name: "Wu Wang / Innocence" },
          { number: 51, name: "Chên / The Arousing" },
          { number: 3, name: "Chun / Difficulty at the Beginning" },
          { number: 27, name: "I / The Corners of the Mouth" },
          { number: 24, name: "Fu / Return" },
          { number: 42, name: "I / Increase" },
          { number: 21, name: "Shih Ho / Biting Through" },
          { number: 17, name: "Sui / Following" }
        ],
        [
          { number: 6, name: "Sung / Conflict" },
          { number: 40, name: "Hsieh / Deliverance" },
          { number: 29, name: "K'an / The Abysmal" },
          { number: 4, name: "Meng / Youthful Folly" },
          { number: 7, name: "Shih / The Army" },
          { number: 59, name: "Huan / Dispersion" },
          { number: 64, name: "Wei Chi / Before Completion" },
          { number: 47, name: "K'un / Oppression" }
        ],
        [
          { number: 33, name: "Tun / Retreat" },
          { number: 62, name: "Hsiao Kuo / Preponderance of the Small" },
          { number: 39, name: "Chien / Obstruction" },
          { number: 52, name: "Kên / Keeping Still" },
          { number: 15, name: "Ch'ien / Modesty" },
          { number: 53, name: "Chien / Development" },
          { number: 56, name: "Lü / The Wanderer" },
          { number: 31, name: "Hsien / Influence" }
        ],
        [
          { number: 12, name: "P'i / Standstill" },
          { number: 16, name: "Yü / Enthusiasm" },
          { number: 8, name: "Pi / Holding Together" },
          { number: 23, name: "Po / Splitting Apart" },
          { number: 2, name: "K'un / The Receptive" },
          { number: 20, name: "Kuan / Contemplation" },
          { number: 35, name: "Chin / Progress" },
          { number: 45, name: "Ts'ui / Gathering Together" }
        ],
        [
          { number: 44, name: "Kou / Coming to Meet" },
          { number: 32, name: "Heng / Duration" },
          { number: 48, name: "Ching / The Well" },
          { number: 18, name: "Ku / Work on What Has Been Spoiled" },
          { number: 46, name: "Shêng / Pushing Upward" },
          { number: 57, name: "Sun / The Gentle" },
          { number: 50, name: "Ting / The Cauldron" },
          { number: 28, name: "Ta Kuo / Preponderance of the Great" }
        ],
        [
          { number: 13, name: "T'ung Jên / Fellowship with Men" },
          { number: 55, name: "Fêng / Abundance" },
          { number: 63, name: "Chi Chi / After Completion" },
          { number: 36, name: "Ming I / Darkening of the Light" },
          { number: 37, name: "Chia Jên / The Family" },
          { number: 30, name: "Li / The Clinging" },
          { number: 49, name: "Ko / Revolution" },
          { number: 22, name: "Pi / Grace" }
        ],
        [
          { number: 10, name: "Lü / Treading" },
          { number: 54, name: "Kuei Mei / The Marrying Maiden" },
          { number: 60, name: "Chieh / Limitation" },
          { number: 41, name: "Sun / Decrease" },
          { number: 19, name: "Lin / Approach" },
          { number: 61, name: "Chung Fu / Inner Truth" },
          { number: 38, name: "K'uei / Opposition" },
          { number: 58, name: "Tui / The Joyous" }
        ]
      ];

      const hexagramDetails = {
        1: {
          judgment: "Creative force gathers; initiate bold, clear action.",
          image: "Heaven moves with power—align with its rhythm and lead."
        },
        2: {
          judgment: "Yielding strength; accept guidance and nurture growth.",
          image: "Earth's vast embrace supports all—remain receptive and steady." },
        3: {
          judgment: "Beginnings are tangled—persist patiently and organize.",
          image: "Thunder within the soil—prepare the ground before planting." },
        4: {
          judgment: "Ignorance seeks instruction—cultivate humility and learn.",
          image: "A spring emerges from a mountain—guide it with discipline." },
        5: {
          judgment: "Wait with inner certainty; nourishment arrives in time.",
          image: "Clouds climb the sky—do not force the rain before it is ready." },
        6: {
          judgment: "Conflict requires clarity and fair counsel.",
          image: "Water climbs toward heaven—seek resolution before strife hardens." },
        7: {
          judgment: "Discipline your forces; unity wins devoted allies.",
          image: "Water within the earth—assemble the troops with purpose." },
        8: {
          judgment: "Join with others through shared sincerity and vision.",
          image: "Water above earth—gather the clan and declare your center." },
        9: {
          judgment: "Small accumulations sustain progress; tend to details.",
          image: "Wind moves within heaven—cultivate gentle influence." },
        10: {
          judgment: "Advance carefully; behave with respect and grace.",
          image: "Heaven above the lake—watch your steps like a tiger on the trail." },
        11: {
          judgment: "Harmony prospers; share abundance widely.",
          image: "Heaven and earth unite—establish balance between realms." },
        12: {
          judgment: "Stagnation blocks virtue; withdraw and preserve integrity.",
          image: "Heaven withdraws from earth—maintain inner worth amid decline." },
        13: {
          judgment: "Fellowship flourishes when motives remain pure.",
          image: "Heaven over fire—the clan gathers in the open plain." },
        14: {
          judgment: "Great possessions invite responsibility; act nobly.",
          image: "Fire high in heaven—radiate generosity without arrogance." },
        15: {
          judgment: "Modesty enriches; reduce excess and extend courtesy.",
          image: "Mountain beneath earth—weight settles evenly on all." },
        16: {
          judgment: "Enthusiasm rallies hearts; prepare by aligning intentions.",
          image: "Thunder bursts from the earth—lead with shared purpose." },
        17: {
          judgment: "Follow what is true; loyalty wins loyal allies.",
          image: "Thunder within the lake—respond to joy with sincerity." },
        18: {
          judgment: "Repair what is spoiled; act decisively to renew.",
          image: "Wind blows over the mountain—patient effort restores order." },
        19: {
          judgment: "Approach with openness; nurture those you lead.",
          image: "Earth welcomes the lake—prepare for arrival by serving others." },
        20: {
          judgment: "Contemplate the broader view before committing.",
          image: "Wind crosses earth—survey the land and refine your conduct." },
        21: {
          judgment: "Bite through obstacles with firm justice.",
          image: "Thunder and fire combine—discern truth and act decisively." },
        22: {
          judgment: "Grace embellishes; let beauty support substance.",
          image: "Fire at the mountain's foot—adorn yet remain grounded." },
        23: {
          judgment: "Peeling away reveals truth; accept necessary endings.",
          image: "Mountain above earth—structures crumble, prepare to rebuild." },
        24: {
          judgment: "Return to the path; renewal follows reflection.",
          image: "Thunder within earth—rest then rise with new commitment." },
        25: {
          judgment: "Innocence aligns with the Tao—avoid cunning.",
          image: "Heaven within thunder—act without ulterior motive." },
        26: {
          judgment: "Tame great power with patience and study.",
          image: "Heaven within the mountain—store strength until needed." },
        27: {
          judgment: "Nourish words and deeds; watch what feeds you.",
          image: "Mountain surrounds thunder—shape your mouth with integrity." },
        28: {
          judgment: "Excessive weight strains the beam—reinforce or release.",
          image: "Lake above wind—support the center before collapse." },
        29: {
          judgment: "Repeated trials demand courage and trust.",
          image: "Water flows endlessly—navigate the abyss with discipline." },
        30: {
          judgment: "Clarity illuminates; cling to what is bright.",
          image: "Fire repeated—tend the flame with mindful devotion." },
        31: {
          judgment: "Gentle influence attracts partnership.",
          image: "Lake at the mountain's foot—respond softly and inspire." },
        32: {
          judgment: "Consistency breeds success; commit for the long term.",
          image: "Thunder and wind entwine—endurance shapes destiny." },
        33: {
          judgment: "Retreat strategically to preserve strength.",
          image: "Heaven on the mountain—withdraw before force overwhelms." },
        34: {
          judgment: "Great power requires restraint and clarity.",
          image: "Thunder rises to heaven—align strength with goodness." },
        35: {
          judgment: "Progress grows through steady effort and courtesy.",
          image: "Fire emerges over earth—dawn reveals new promise." },
        36: {
          judgment: "Protect the light under adversity.",
          image: "Fire sinks beneath earth—hide brilliance until safe." },
        37: {
          judgment: "Order the family; align roles with kindness.",
          image: "Wind within fire—cultivate warmth in the home." },
        38: {
          judgment: "Opposition sparks clarity—seek common ground.",
          image: "Fire above lake—differ yet stay in respectful dialogue." },
        39: {
          judgment: "Obstacles counsel pause; seek assistance.",
          image: "Water at the mountain—turn back to regroup." },
        40: {
          judgment: "Release tension; forgive and move onward.",
          image: "Thunder and rain—storms cleanse and restore calm." },
        41: {
          judgment: "Decrease excess to reveal meaning.",
          image: "Mountain above lake—choose simplicity over indulgence." },
        42: {
          judgment: "Increase through generosity; give where it counts.",
          image: "Wind and thunder—growth follows wholehearted support." },
        43: {
          judgment: "Break through; declare truth openly.",
          image: "Lake surges to heaven—announce decisions without fear." },
        44: {
          judgment: "Encounter demands vigilance; set firm boundaries.",
          image: "Wind below heaven—meet the unexpected with awareness." },
        45: {
          judgment: "Gather community—offer a clear purpose.",
          image: "Lake above earth—draw people together with sincerity." },
        46: {
          judgment: "Rise steadily through devotion.",
          image: "Wind within earth—push upward with gentleness." },
        47: {
          judgment: "Oppression tests endurance—hold to inner truth.",
          image: "Water in the lake—remain faithful despite confinement." },
        48: {
          judgment: "The Well nourishes all—maintain purity.",
          image: "Water over wood—draw from the source responsibly." },
        49: {
          judgment: "Revolution succeeds with timing and sincerity.",
          image: "Fire in the lake—renew forms with heartfelt intent." },
        50: {
          judgment: "The Cauldron transforms—honor the sacred vessel.",
          image: "Fire over wood—nourish spirit and culture." },
        51: {
          judgment: "Shock awakens; respond with composure.",
          image: "Thunder repeated—stay rooted when startled." },
        52: {
          judgment: "Stillness clarifies—quiet the mind.",
          image: "Mountain upon mountain—remain centered within." },
        53: {
          judgment: "Gradual progress matures relationships.",
          image: "Tree on the mountain—growth is deliberate and sure." },
        54: {
          judgment: "Adapt to circumstance with dignity.",
          image: "Thunder over lake—honor commitments even when misaligned." },
        55: {
          judgment: "Abundance shines—share brilliance wisely.",
          image: "Thunder and fire—celebrate yet remain aware of decline." },
        56: {
          judgment: "The traveler succeeds with humility and decorum.",
          image: "Fire on the mountain—move lightly and respect customs." },
        57: {
          judgment: "Gentle penetration achieves influence.",
          image: "Wind repeats—persevering persuasion shapes fate." },
        58: {
          judgment: "Joy shared deepens trust.",
          image: "Lake repeats—dialogue creates harmony." },
        59: {
          judgment: "Disperse hardness; return to clarity.",
          image: "Wind over water—let sincerity dissolve barriers." },
        60: {
          judgment: "Limitation grants freedom through structure.",
          image: "Water above lake—set clear boundaries with compassion." },
        61: {
          judgment: "Inner truth guides lasting bonds.",
          image: "Wind within lake—sincerity moves hearts." },
        62: {
          judgment: "Attend the small; avoid grand gestures.",
          image: "Thunder above mountain—flight of the small bird." },
        63: {
          judgment: "Completion demands vigilance to sustain success.",
          image: "Water above fire—balance opposing forces with care." },
        64: {
          judgment: "Before completion—align pieces before acting.",
          image: "Fire above water—prepare thoroughly before the leap." }
      };

      const lineInputsContainer = document.getElementById("lineInputs");
      const calculateButton = document.getElementById("calculate");
      const resetButton = document.getElementById("reset");
      const tossAllButton = document.getElementById("tossAll");
      const resultsSection = document.getElementById("results");
      const lineSummarySection = document.querySelector(".line-summary");
      const hexagramDisplay = document.getElementById("hexagramDisplay");
      const secondaryNote = document.getElementById("secondaryNote");
      const progressLabel = document.getElementById("progressLabel");
      const progressBar = document.getElementById("progressBar");
      const progressTrack = document.querySelector(".progress-track");
      const lineTimeline = document.getElementById("lineTimeline");

      const lineOrder = Array.from({ length: totalLines }, (_, index) => index + 1);
      let lineCardElements = [];
      let lineStepButtons = [];
      let currentLineIndex = 0;

      function createLineCard({ lineNumber, tooltip }) {
        const card = document.createElement("div");
        card.className = "line-card";
        card.dataset.lineNumber = lineNumber;

        const header = document.createElement("div");
        header.className = "line-top";
        const meta = document.createElement("div");
        meta.className = "line-meta";
        const title = document.createElement("span");
        title.className = "line-name";
        title.textContent = `Line ${lineNumber}`;
        const role = document.createElement("span");
        role.className = "line-role";
        role.textContent = lineRoles[lineNumber];
        meta.append(title, role);
        const tip = document.createElement("span");
        tip.className = "tooltip";
        tip.title = tooltip;
        tip.textContent = "?";
        header.append(meta, tip);

        const preview = document.createElement("div");
        preview.className = "line-preview";
        const miniLine = document.createElement("div");
        miniLine.className = "mini-line";
        miniLine.dataset.role = "mini-line";
        const status = document.createElement("span");
        status.className = "line-detail-text";
        status.dataset.role = "status-text";
        status.textContent = "Awaiting toss";
        preview.append(miniLine, status);

        const controls = document.createElement("div");
        controls.className = "controls";

        const selectWrapper = document.createElement("label");
        selectWrapper.textContent = "Heads:";
        const select = document.createElement("select");
        select.dataset.role = "heads";
        select.dataset.lineNumber = lineNumber;
        headsOptions.forEach((opt) => {
          const option = document.createElement("option");
          option.value = opt.value;
          option.textContent = opt.label;
          select.append(option);
        });
        selectWrapper.appendChild(select);

        const tossButton = document.createElement("button");
        tossButton.type = "button";
        tossButton.textContent = "Toss Coins";
        tossButton.addEventListener("click", () => {
          const heads = simulateToss();
          select.value = heads.toString();
          updateLineResult(card, heads);
        });

        select.addEventListener("change", (event) => {
          const value = event.target.value;
          const index = Number(card.dataset.index || 0);
          if (value === "") {
            handleLineClear(index);
            return;
          }
          updateLineResult(card, Number(value));
        });

        controls.append(selectWrapper, tossButton);
        card.append(header, preview, controls);
        return card;
      }

      function resetLineCard(card, { clearSelection = false, resetStep = true } = {}) {
        if (!card) return;

        if (clearSelection) {
          const select = card.querySelector("select[data-role='heads']");
          if (select) {
            select.value = "";
          }
        }

        card.classList.remove("completed", "has-change");
        const status = card.querySelector("[data-role='status-text']");
        const miniLine = card.querySelector("[data-role='mini-line']");
        if (status) {
          status.textContent = "Awaiting toss";
        }
        if (miniLine) {
          miniLine.className = "mini-line";
        }
        card.removeAttribute("data-sum");
        card.removeAttribute("data-changing");
        card.dataset.completed = "false";

        if (resetStep) {
          const index = Number(card.dataset.index || 0);
          updateStepSummary(index, null);
        }
      }

      function updateLineResult(card, heads) {
        const tails = 3 - heads;
        const sum = heads * 3 + tails * 2;
        const type = sum % 2 === 1 ? "solid" : "broken";
        const changing = sum === 6 || sum === 9;
        const index = Number(card.dataset.index || 0);
        const wasComplete = card.dataset.completed === "true";
        const status = card.querySelector("[data-role='status-text']");
        const miniLine = card.querySelector("[data-role='mini-line']");

        if (miniLine) {
          miniLine.className = "mini-line";
          miniLine.classList.add(type);
          if (changing) {
            miniLine.classList.add("changing");
          }
        }

        if (status) {
          const descriptor = lineNatureDescriptions[sum] || `Sum ${sum}`;
          status.textContent = `${descriptor} — ${heads}H / ${tails}T`;
          updateStepSummary(index, {
            descriptor,
            heads,
            tails,
            changing
          });
        }

        card.classList.add("completed");
        card.classList.toggle("has-change", changing);
        card.dataset.sum = String(sum);
        card.dataset.changing = changing ? "true" : "false";
        card.dataset.completed = "true";

        markStepCompleted(index, changing);

        if (!wasComplete && index === currentLineIndex) {
          const nextIndex = index + 1;
          if (nextIndex < lineCardElements.length) {
            activateLineByIndex(nextIndex);
          } else {
            currentLineIndex = index;
            lineStepButtons[index]?.classList.add("active-step");
            lineCardElements[index]?.classList.add("active-line");
          }
        }

        updateProgress();
        const selects = Array.from(document.querySelectorAll("select[data-role='heads']"));
        const completed = selects.every((sel) => sel.value !== "");
        if (completed) {
          handleCalculate();
        }
      }

      function updateStepSummary(index, summary) {
        const step = lineStepButtons[index];
        if (!step) return;
        const statusSpan = step.querySelector(".step-status");
        if (!statusSpan) return;

        if (!summary) {
          statusSpan.textContent = "Awaiting toss";
          step.classList.remove("completed-step", "has-change");
          return;
        }

        const { descriptor, heads, tails, changing } = summary;
        const counts = heads !== undefined ? ` — ${heads}H / ${tails}T` : "";
        statusSpan.textContent = `${descriptor}${counts}`;
        step.classList.add("completed-step");
        step.classList.toggle("has-change", Boolean(changing));
      }

      function markStepCompleted(index, isChanging) {
        const step = lineStepButtons[index];
        if (!step) return;
        step.disabled = false;
        step.classList.add("completed-step");
        step.classList.toggle("has-change", Boolean(isChanging));
        const nextStep = lineStepButtons[index + 1];
        if (nextStep) {
          nextStep.disabled = false;
        }
      }

      function activateLineByIndex(index) {
        const step = lineStepButtons[index];
        if (!step || step.disabled) return;
        currentLineIndex = index;

        lineCardElements.forEach((card, cardIndex) => {
          card.classList.toggle("active-line", cardIndex === index);
        });

        lineStepButtons.forEach((btn, btnIndex) => {
          btn.classList.toggle("active-step", btnIndex === index);
        });

        const activeCard = lineCardElements[index];
        if (activeCard) {
          const select = activeCard.querySelector("select[data-role='heads']");
          if (select) {
            setTimeout(() => select.focus({ preventScroll: false }), 30);
          }
        }
      }

      function handleLineClear(startIndex) {
        for (let i = startIndex; i < lineCardElements.length; i += 1) {
          const card = lineCardElements[i];
          resetLineCard(card, { clearSelection: i !== startIndex, resetStep: true });
          const step = lineStepButtons[i];
          if (step) {
            step.disabled = i !== startIndex;
            step.classList.remove("completed-step", "has-change", "active-step");
            const statusSpan = step.querySelector(".step-status");
            if (statusSpan) {
              statusSpan.textContent = "Awaiting toss";
            }
          }
        }

        activateLineByIndex(startIndex);
        updateProgress();
      }

      function simulateToss() {
        let heads = 0;
        for (let i = 0; i < 3; i += 1) {
          heads += Math.random() < 0.5 ? 0 : 1;
        }
        return heads;
      }

      function updateProgress() {
        const selects = Array.from(document.querySelectorAll("select[data-role='heads']"));
        const completed = selects.filter((select) => select.value !== "").length;
        const percent = (completed / totalLines) * 100;

        if (progressLabel) {
          progressLabel.textContent =
            completed === totalLines
              ? "All lines set — ready to reveal"
              : `${completed} / ${totalLines} lines set`;
        }

        if (progressBar) {
          progressBar.style.width = `${percent}%`;
          progressBar.classList.toggle("complete", completed === totalLines);
        }

        if (progressTrack) {
          progressTrack.setAttribute("aria-valuenow", String(completed));
          progressTrack.setAttribute(
            "aria-valuetext",
            completed === totalLines ? "Complete" : `${completed} of ${totalLines} lines`
          );
        }

        calculateButton.disabled = completed !== totalLines;
      }

      function buildLineCards() {
        lineInputsContainer.innerHTML = "";
        lineTimeline.innerHTML = "";
        lineCardElements = [];
        lineStepButtons = [];

        lineOrder.forEach((lineNumber, index) => {
          const card = createLineCard({ lineNumber, tooltip: lineTooltips[lineNumber] });
          card.dataset.index = String(index);
          card.dataset.completed = "false";
          lineInputsContainer.appendChild(card);
          lineCardElements.push(card);

          const stepButton = document.createElement("button");
          stepButton.type = "button";
          stepButton.className = "line-step";
          stepButton.dataset.index = String(index);
          stepButton.dataset.lineNumber = String(lineNumber);
          stepButton.innerHTML = `
            <span class="step-label">Line ${lineNumber}</span>
            <span class="step-role">${lineRoles[lineNumber]}</span>
            <span class="step-status">Awaiting toss</span>
          `;
          stepButton.disabled = index !== 0;
          stepButton.addEventListener("click", () => {
            if (!stepButton.disabled) {
              activateLineByIndex(index);
            }
          });
          lineTimeline.appendChild(stepButton);
          lineStepButtons.push(stepButton);

          resetLineCard(card, { resetStep: true });
        });

        currentLineIndex = 0;
        activateLineByIndex(0);
        updateProgress();
      }

      function collectLineData() {
        const cards = Array.from(document.querySelectorAll(".line-card"));
        const data = [];

        for (let i = cards.length - 1; i >= 0; i -= 1) {
          const card = cards[i];
          const select = card.querySelector("select");
          if (!select.value) {
            const lineNumber = card.dataset.lineNumber;
            throw new Error(`Please set the heads count for Line ${lineNumber}.`);
          }
          const heads = Number(select.value);
          const tails = 3 - heads;
          const sum = heads * 3 + tails * 2;
          const isSolid = sum % 2 === 1;
          const isChanging = sum === 6 || sum === 9;
          const nextIsSolid = sum === 6 ? true : sum === 9 ? false : isSolid;

          data.push({
            lineNumber: Number(card.dataset.lineNumber),
            heads,
            tails,
            sum,
            isSolid,
            isChanging,
            nextIsSolid
          });
        }
        data.sort((a, b) => a.lineNumber - b.lineNumber);
        return data;
      }

      function binaryFromLines(lines, start, end) {
        let binary = "";
        for (let i = start; i < end; i += 1) {
          binary += lines[i].isSolid ? "1" : "0";
        }
        return binary;
      }

      function binaryFromNextLines(lines, start, end) {
        let binary = "";
        for (let i = start; i < end; i += 1) {
          binary += lines[i].nextIsSolid ? "1" : "0";
        }
        return binary;
      }

      function getHexagram(lines, useNext = false) {
        const lowerBinary = useNext
          ? binaryFromNextLines(lines, 0, 3)
          : binaryFromLines(lines, 0, 3);
        const upperBinary = useNext
          ? binaryFromNextLines(lines, 3, 6)
          : binaryFromLines(lines, 3, 6);

        const lowerIndex = trigramMap[lowerBinary];
        const upperIndex = trigramMap[upperBinary];

        if (lowerIndex === undefined || upperIndex === undefined) {
          throw new Error("Invalid trigram combination encountered.");
        }

        const baseInfo = hexagramChart[lowerIndex][upperIndex];
        const detail = hexagramDetails[baseInfo.number] || {
          judgment: "Consult your I Ching reference for full meaning.",
          image: "Guidance unavailable in summary."
        };

        return {
          number: baseInfo.number,
          name: baseInfo.name,
          judgment: detail.judgment,
          image: detail.image,
          lines: lines.map((line) => ({
            isSolid: useNext ? line.nextIsSolid : line.isSolid,
            isChanging: !useNext && line.isChanging
          }))
        };
      }

      function renderLineSummary(lines) {
        const wrapper = document.createElement("div");
        wrapper.className = "line-grid";

        for (let i = lines.length - 1; i >= 0; i -= 1) {
          const line = lines[i];
          const row = document.createElement("div");
          row.className = "line-row";
          if (line.isChanging) {
            row.classList.add("changing");
          }

          const label = document.createElement("div");
          label.innerHTML = `<strong>Line ${line.lineNumber}</strong><div>${lineRoles[line.lineNumber]}</div>`;

          const sum = document.createElement("div");
          sum.textContent = `Sum ${line.sum}`;

          const counts = document.createElement("div");
          counts.textContent = `${line.heads} heads / ${line.tails} tails`;

          const nature = document.createElement("div");
          nature.textContent = line.isSolid ? "Yang (solid)" : "Yin (broken)";

          const change = document.createElement("div");
          change.textContent = line.isChanging
            ? line.sum === 6
              ? "Changing — old yin → yang"
              : "Changing — old yang → yin"
            : "Static line";

          row.append(label, sum, counts, nature, change);
          wrapper.appendChild(row);
        }

        lineSummarySection.innerHTML = "";
        lineSummarySection.innerHTML = "<h2>Line Analysis</h2>";
        lineSummarySection.appendChild(wrapper);
      }

      function renderHexagramCard({ label, hexagram }) {
        const card = document.createElement("article");
        card.className = "hexagram-card";

        const title = document.createElement("h2");
        title.textContent = label;

        const diagram = document.createElement("div");
        diagram.className = "hexagram-diagram";
        for (let i = hexagram.lines.length - 1; i >= 0; i -= 1) {
          const line = hexagram.lines[i];
          const lineDiv = document.createElement("div");
          lineDiv.className = `hexagram-line ${line.isSolid ? "solid" : "broken"}`;
          if (line.isChanging) {
            lineDiv.classList.add("changing");
          }
          const ariaParts = [line.isSolid ? "Yang line" : "Yin line"];
          if (line.isChanging) {
            ariaParts.push("changing");
          }
          lineDiv.setAttribute("aria-label", ariaParts.join(" · "));
          diagram.appendChild(lineDiv);
        }

        const info = document.createElement("div");
        info.className = "hexagram-info";
        const heading = document.createElement("h3");
        heading.textContent = `${hexagram.number} – ${hexagram.name}`;
        const judgment = document.createElement("p");
        judgment.innerHTML = `<strong>Judgment:</strong> ${hexagram.judgment}`;
        const image = document.createElement("p");
        image.innerHTML = `<strong>Image:</strong> ${hexagram.image}`;
        info.append(heading, judgment, image);

        card.append(title, diagram, info);
        return card;
      }

      function handleCalculate() {
        try {
          const lines = collectLineData();
          const primaryHexagram = getHexagram(lines);
          const hasChanges = lines.some((line) => line.isChanging);
          let relatedHexagram = null;

          if (hasChanges) {
            relatedHexagram = getHexagram(lines, true);
          }

          renderLineSummary(lines);
          hexagramDisplay.innerHTML = "";
          hexagramDisplay.appendChild(
            renderHexagramCard({ label: "Primary Hexagram", hexagram: primaryHexagram })
          );

          if (hasChanges && relatedHexagram) {
            hexagramDisplay.appendChild(
              renderHexagramCard({ label: "Relating Hexagram", hexagram: relatedHexagram })
            );
            secondaryNote.hidden = true;
            secondaryNote.textContent = "";
          } else {
            secondaryNote.hidden = false;
            secondaryNote.textContent = "Static hexagram—no relating changes.";
          }

          resultsSection.classList.add("active");
          resultsSection.scrollIntoView({ behavior: "smooth", block: "start" });
        } catch (error) {
          alert(error.message);
        }
      }

      function handleReset() {
        resultsSection.classList.remove("active");
        hexagramDisplay.innerHTML = "";
        lineSummarySection.innerHTML = "";
        secondaryNote.hidden = true;
        secondaryNote.textContent = "";
        buildLineCards();
      }

      calculateButton.addEventListener("click", handleCalculate);
      if (tossAllButton) {
        tossAllButton.addEventListener("click", () => {
          handleReset();
          lineOrder.forEach((_, index) => {
            const card = lineCardElements[index];
            if (!card) return;
            const select = card.querySelector("select[data-role='heads']");
            const heads = simulateToss();
            if (select) {
              select.value = heads.toString();
            }
            updateLineResult(card, heads);
          });
          handleCalculate();
        });
      }
      resetButton.addEventListener("click", handleReset);

      buildLineCards();
    </script>
  </body>
</html>

